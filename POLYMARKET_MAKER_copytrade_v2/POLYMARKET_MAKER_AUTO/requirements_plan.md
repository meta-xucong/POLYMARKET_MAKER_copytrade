# poly_maker_autorun 改造需求与实施方案

## 背景与目标
- 将 `Customize_fliter_blacklist.py` 的话题筛选能力与 `POLYMARKET_MAKER/Volatility_arbitrage_run.py` 的挂单波段交易组合成一体化自动运行流程。
- 新建位于仓库根目录的入口脚本 `poly_maker_autorun.py`，无需交互式输入，支持多话题并发、状态监控、单话题停止，以及新旧话题增量识别；核心挂单逻辑仍集中在 `POLYMARKET_MAKER/` 目录内。

## 功能性需求
1. **入口脚本**：运行后自动执行筛选脚本，解析出符合条件的话题列表；为每个新话题按预设参数启动波段交易脚本。
2. **参数预置**：所有运行参数通过 JSON/配置文件预设，运行时无需手动输入。支持全局调度配置与策略参数模板，必要时按话题覆盖。
3. **并发执行**：同时运行多个话题，提供最大并发控制，支持队列化启动。建议使用进程管理以避免 GIL 影响。
4. **状态监控**：可查看当前运行的话题、启动时间、最近心跳/日志摘要、运行状态（运行中/已停止/异常）。展示形式可沿用原有 CLI 样式或基于 `rich` 的表格输出。
5. **单话题控制**：支持通过命令接口（REPL 命令或简单 CLI 参数）停止指定话题；必要时提供强制结束选项。
6. **增量识别**：维护已处理话题的持久化记录（如 `data/handled_topics.json`）；再次运行时仅启动新出现的话题，已处理的跳过。
7. **健壮性**：筛选或子进程异常需可捕获、记录并选择性重试，整体流程不中断；确保退出时清理子进程。
8. **日志与路径**：统一日志目录，记录主程序与子任务输出；配置文件路径、筛选结果文件、历史记录文件需可配置。
9. **可选扩展**：支持手动重置历史记录、调整并发度与轮询周期，便于演练与生产切换。

## 改造思路
- **流程编排**：`poly_maker_autorun.py` 负责 orchestrate 全流程：加载配置 → 运行筛选脚本 → 读取结果 → 与历史记录比对 → 启动新话题子进程 → 监控与交互。
- **子进程调用**：通过 `subprocess.Popen` 或 `multiprocessing.Process` 启动 `Volatility_arbitrage_run.py`，以命令行参数或环境变量注入预设 JSON 参数；筛选脚本可通过子进程调用并输出 JSON/CSV。
- **状态管理**：维护内存中的任务表（话题 ID → 进程句柄、状态、启动时间、日志路径、重试计数），周期性心跳检查更新；支持命令触发状态打印与停止。
- **持久化与去重**：将已启动/成功的话题 ID 持久化，启动新任务后即时写盘；提供清空或忽略历史的配置开关。
- **容错与重试**：对筛选调用设置超时与重试；对子进程异常退出提供可配置重试上限，并记录原因；全局异常时确保优雅退出并回收进程。
- **演练策略**：先用小型静态筛选结果验证闭环（筛选→去重→并发→监控→停止→重启），再替换为真实接口与参数。

## 任务步骤
1. **创建入口脚本骨架**：新增 `poly_maker_autorun.py`，实现配置加载、主循环、命令/交互入口的基础结构。
2. **配置体系落地**：
   - 新建 `config/global_config.json`（调度：并发数、轮询周期、日志/数据文件路径、重试策略等）。
   - 新建 `config/strategy_defaults.json`（策略参数模板；支持按话题 ID/名称覆盖的可选结构）。
3. **筛选结果对接**：封装调用 `Customize_fliter_blacklist.py` 的函数，设定输出文件（如 `data/topics_filtered.json`），并解析为话题列表。
4. **历史记录与增量识别**：实现读取/写入 `data/handled_topics.json` 的工具函数；计算新话题集合并在启动后更新记录。
5. **子进程调度与并发控制**：
   - 设计任务表结构与并发控制（进程池或手动维护 `Popen` 列表）。
   - 根据配置生成每个话题的参数并启动 `Volatility_arbitrage_run.py` 子进程，绑定独立日志文件。
6. **监控与控制接口**：
   - 编写心跳循环，定期检查子进程存活与日志片段，更新状态。
   - 提供命令接口（如简单 REPL：`list`/`stop <topic_id>`/`exit`）或 CLI 参数模式，输出状态表并处理停止请求。
7. **异常处理与清理**：为筛选/子进程调用添加超时、异常捕获、可选重试；确保主程序退出时终止所有子进程并写回状态。
8. **演练与验证**：
   - 使用伪造筛选结果或小型真实数据进行 dry run，验证增量逻辑与并发限制。
   - 测试重启后老话题跳过、新话题自动启动；验证停止指令和异常场景处理。
9. **文档与使用说明**：在 README 或单独文档中补充运行方式、配置示例、命令说明、日志/数据文件位置。

## 交付物
- `poly_maker_autorun.py` 主控脚本。
- `config/global_config.json`、`config/strategy_defaults.json` 示例或模板。
- 增量记录文件（如 `data/handled_topics.json`）的格式说明。
- 更新后的使用说明文档（运行步骤、配置说明、控制指令、日志路径）。
