# è´Ÿè½½å½±å“åˆ†æä¸å¹³è¡¡ä¿®å¤æ–¹æ¡ˆ

## è´Ÿè½½å½±å“è¯„ä¼°

### âŒ ä¸ä¼šå¢åŠ çš„è´Ÿè½½
1. **WSè¿æ¥æ•°ï¼š** ä»ç„¶æ˜¯1ä¸ªèšåˆè¿æ¥ï¼ˆä¸å˜ï¼‰
2. **APIè°ƒç”¨æ¬¡æ•°ï¼š** ç­–ç•¥è®¡ç®—æ˜¯çº¯å†…å­˜æ“ä½œï¼Œä¸è°ƒç”¨API
3. **æ–‡ä»¶I/Oé¢‘ç‡ï¼š** ç¼“å­˜è¯»å–ä»æ˜¯1ç§’/æ¬¡ï¼ˆä¸»å¾ªç¯æ§åˆ¶ï¼‰
4. **ç½‘ç»œå¸¦å®½ï¼š** WSäº‹ä»¶æ¥æ”¶é¢‘ç‡ä¸å˜

### âœ… ä¼šå¢åŠ çš„è´Ÿè½½
1. **`strategy.on_tick()` è°ƒç”¨é¢‘ç‡ï¼š** 2æ¬¡/åˆ†é’Ÿ â†’ 30æ¬¡/åˆ†é’Ÿ
2. **CPUè®¡ç®—ï¼š** ä»·æ ¼çª—å£ç»´æŠ¤ã€æ³¢åŠ¨ç‡è®¡ç®—ï¼ˆçº¯å†…å­˜æ“ä½œï¼‰

### è´Ÿè½½é‡åŒ–åˆ†æ

å‡è®¾åŒæ—¶è¿è¡Œ40ä¸ªtokenï¼š

| æŒ‡æ ‡ | å½“å‰ï¼ˆ10ç§’ï¼‰ | å¿«é€Ÿä¿®å¤ï¼ˆ2ç§’ï¼‰ | å¢é‡ |
|------|-------------|----------------|------|
| æ¯ç§’on_tickè°ƒç”¨ | 1.3æ¬¡ | 20æ¬¡ | +15å€ |
| CPUä½¿ç”¨ç‡ | ~5% | ~10-15% | +10% |
| å†…å­˜å¢é•¿ | å¿½ç•¥ | å¿½ç•¥ | å¯å¿½ç•¥ |

**ç»“è®ºï¼š** CPUè´Ÿè½½ä¼šå¢åŠ ï¼Œä½†ä»åœ¨å¯æ¥å—èŒƒå›´å†…ï¼ˆå› ä¸ºæ˜¯è½»é‡çº§çº¯å†…å­˜è®¡ç®—ï¼‰ã€‚

---

## ğŸ¯ å¹³è¡¡ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å‘¨æœŸ | æ›´æ–°é¢‘ç‡ | çª—å£æ•°æ®ç‚¹ | CPUè´Ÿè½½ | æ•ˆæœ |
|------|------|---------|-----------|---------|------|
| å½“å‰çŠ¶æ€ | 10ç§’ | 2/åˆ†é’Ÿ | 10ä¸ª | åŸºå‡† | âŒ å¤ªä½ |
| **å¹³è¡¡æ–¹æ¡ˆ** | **5ç§’** | **12/åˆ†é’Ÿ** | **60ä¸ª** | **+5%** | âœ… æ¨è |
| æ¿€è¿›æ–¹æ¡ˆ | 2ç§’ | 30/åˆ†é’Ÿ | 150ä¸ª | +10% | âœ… æ›´å¥½ |
| æç«¯æ–¹æ¡ˆ | 1ç§’ | 60/åˆ†é’Ÿ | 300ä¸ª | +20% | âš ï¸ å¯èƒ½è¿‡è½½ |

### æ¨èï¼š5ç§’å‘¨æœŸï¼ˆå¹³è¡¡æ–¹æ¡ˆï¼‰

**ä¿®æ”¹ä½ç½®ï¼š** `Volatility_arbitrage_run.py` ç¬¬2722è¡Œ

```python
# æ”¹ä¸º5ç§’ï¼ˆè€Œä¸æ˜¯2ç§’ï¼‰
if time_since_last_tick >= 5.0:  # å¹³è¡¡æ€§èƒ½å’Œå“åº”é€Ÿåº¦
    should_feed_strategy = True
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ›´æ–°é¢‘ç‡æå‡6å€ï¼ˆ2/min â†’ 12/minï¼‰
- âœ… 5åˆ†é’Ÿçª—å£æ•°æ®ç‚¹ä»10ä¸ªå¢åŠ åˆ°60ä¸ªï¼ˆè¶³å¤Ÿå‡†ç¡®ï¼‰
- âœ… CPUè´Ÿè½½å¢åŠ é€‚ä¸­ï¼ˆçº¦5%ï¼‰
- âœ… èƒ½åŒæ—¶è¿è¡Œæ›´å¤štoken

**æ‰§è¡Œå‘½ä»¤ï¼š**
```bash
cd /home/user/POLYMARKET_MAKER_copytrade/POLYMARKET_MAKER_copytrade_v2/POLYMARKET_MAKER_AUTO/POLYMARKET_MAKER

# å¤‡ä»½
cp Volatility_arbitrage_run.py Volatility_arbitrage_run.py.bak

# ä¿®æ”¹ä¸º5ç§’
sed -i '2722s/10\.0/5.0/' Volatility_arbitrage_run.py

# éªŒè¯
grep -n "time_since_last_tick >= " Volatility_arbitrage_run.py | grep -A2 -B2 "5\.0"
```

---

## ğŸš€ æ›´ä¼˜æ–¹æ¡ˆï¼šæ™ºèƒ½è§¦å‘ï¼ˆæ¨èï¼‰

### æ ¸å¿ƒæ€è·¯
ä¸è¦ç›²ç›®å‘¨æœŸæ€§æ›´æ–°ï¼Œè€Œæ˜¯**åªåœ¨æ•°æ®çœŸæ­£å˜åŒ–æ—¶æ‰æ›´æ–°ç­–ç•¥**ã€‚

### å®ç°ï¼šåŸºäºæ–‡ä»¶ä¿®æ”¹æ—¶é—´æˆ³

**ä¿®æ”¹ä½ç½®ï¼š** `Volatility_arbitrage_run.py` çš„ `_apply_shared_ws_snapshot()` å‡½æ•°

**å½“å‰é—®é¢˜ï¼š**
- å³ä½¿ç¼“å­˜æ–‡ä»¶å†…å®¹ä¸å˜ï¼Œä¹Ÿè¦ç­‰å¾…10ç§’å‘¨æœŸ
- å³ä½¿ç¼“å­˜æ–‡ä»¶æ›´æ–°äº†ï¼Œä½†seqä¸å˜æ—¶ä¹Ÿè¦ç­‰å¾…10ç§’

**æ”¹è¿›æ–¹æ¡ˆï¼š**
```python
def _apply_shared_ws_snapshot() -> None:
    nonlocal last_shared_ts, last_signal_ts
    snapshot = _load_shared_ws_snapshot()

    # ... çœç•¥å‰é¢çš„ä»£ç  ...

    # âœ… å¢åŠ ï¼šæ£€æŸ¥ç¼“å­˜æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´
    if not hasattr(_apply_shared_ws_snapshot, "_last_file_mtime"):
        _apply_shared_ws_snapshot._last_file_mtime = 0.0

    try:
        current_mtime = os.path.getmtime(shared_ws_cache_path)
    except OSError:
        current_mtime = 0.0

    file_was_updated = current_mtime > _apply_shared_ws_snapshot._last_file_mtime

    # æ”¹è¿›çš„å»é‡é€»è¾‘ï¼š
    if seq > _apply_shared_ws_snapshot._last_seq:
        # seqé€’å¢ â†’ å¿…å®šæ˜¯æ–°æ•°æ®
        should_feed_strategy = True
    elif seq < _apply_shared_ws_snapshot._last_seq:
        # seqé‡ç½® â†’ èšåˆå™¨é‡å¯
        should_feed_strategy = True
    elif is_initializing:
        # åˆå§‹åŒ–
        should_feed_strategy = True
    elif seq == _apply_shared_ws_snapshot._last_seq:
        if updated_at > _apply_shared_ws_snapshot._last_updated_at:
            # updated_atå˜åŒ– â†’ æ–°æ•°æ®
            should_feed_strategy = True
        elif file_was_updated:
            # âœ… å…³é”®æ”¹è¿›ï¼šæ–‡ä»¶è¢«ä¿®æ”¹äº†ï¼Œè¯´æ˜èšåˆå™¨æœ‰æ›´æ–°
            # å³ä½¿seqå’Œupdated_atä¸å˜ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»–tokençš„æ›´æ–°è§¦å‘äº†æ–‡ä»¶åˆ·æ–°
            time_since_last_tick = now - _apply_shared_ws_snapshot._last_tick_ts
            if time_since_last_tick >= 2.0:  # æœ€å¤š2ç§’å»¶è¿Ÿ
                should_feed_strategy = True
                _apply_shared_ws_snapshot._last_file_mtime = current_mtime
        else:
            # æ–‡ä»¶æ²¡å˜åŒ–ï¼Œä½¿ç”¨æ›´é•¿çš„å‘¨æœŸï¼ˆå¦‚10ç§’ï¼‰
            time_since_last_tick = now - _apply_shared_ws_snapshot._last_tick_ts
            if time_since_last_tick >= 10.0:
                should_feed_strategy = True

    # ... åç»­ä»£ç  ...
```

**ä¼˜åŠ¿ï¼š**
- âœ… **åŠ¨æ€å“åº”ï¼š** æœ‰æ–°æ•°æ®æ—¶ç«‹å³å“åº”ï¼ˆ2ç§’å†…ï¼‰ï¼Œæ— æ–°æ•°æ®æ—¶ä¸æµªè´¹CPUï¼ˆ10ç§’å‘¨æœŸï¼‰
- âœ… **è´Ÿè½½ä¼˜åŒ–ï¼š** æ¨ªç›˜tokençš„CPUå ç”¨é™ä½ï¼Œæ´»è·ƒtokençš„å“åº”é€Ÿåº¦æé«˜
- âœ… **æœ€ä¼˜å¹³è¡¡ï¼š** è‡ªé€‚åº”è°ƒæ•´ï¼Œä¸éœ€è¦æ‰‹åŠ¨é€‰æ‹©å‘¨æœŸ

---

## ğŸ“Š ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”

### åœºæ™¯1ï¼šæ´»è·ƒtokenï¼ˆé¢‘ç¹price_changeï¼‰

| æ–¹æ¡ˆ | è¡Œä¸º | æ›´æ–°é¢‘ç‡ | CPUå ç”¨ |
|------|------|---------|---------|
| å½“å‰ï¼ˆ10ç§’ï¼‰ | æ¯æ¬¡seqå˜åŒ–+10ç§’å…œåº• | 12-15/min | åŸºå‡† |
| å¹³è¡¡ï¼ˆ5ç§’ï¼‰ | æ¯æ¬¡seqå˜åŒ–+5ç§’å…œåº• | 20-25/min | +5% |
| æ™ºèƒ½è§¦å‘ | æ¯æ¬¡æ–‡ä»¶æ›´æ–°+2ç§’é™æµ | 25-40/min | +3%ï¼ˆåŠ¨æ€ï¼‰ |

### åœºæ™¯2ï¼šæ¨ªç›˜tokenï¼ˆå¾ˆå°‘price_changeï¼‰

| æ–¹æ¡ˆ | è¡Œä¸º | æ›´æ–°é¢‘ç‡ | CPUå ç”¨ |
|------|------|---------|---------|
| å½“å‰ï¼ˆ10ç§’ï¼‰ | çº¯é 10ç§’å…œåº• | 6/min | åŸºå‡† |
| å¹³è¡¡ï¼ˆ5ç§’ï¼‰ | çº¯é 5ç§’å…œåº• | 12/min | +5% |
| æ™ºèƒ½è§¦å‘ | æ–‡ä»¶æ²¡å˜æ—¶10ç§’å…œåº• | 6-8/min | +0%ï¼ˆä¸å˜ï¼‰ |

**ç»“è®ºï¼š** æ™ºèƒ½è§¦å‘æ–¹æ¡ˆæœ€ä¼˜ï¼Œèƒ½åœ¨ä¿æŒä½è´Ÿè½½çš„åŒæ—¶æé«˜å“åº”é€Ÿåº¦ã€‚

---

## ğŸ” ç›‘æ§ç³»ç»Ÿè´Ÿè½½

### å®æ—¶ç›‘æ§å‘½ä»¤
```bash
# ç›‘æ§CPUä½¿ç”¨ç‡ï¼ˆæŒ‰è¿›ç¨‹ï¼‰
top -b -n 1 | grep python | head -10

# ç›‘æ§æ•´ä½“CPUå’Œå†…å­˜
htop  # æˆ– top

# ç›‘æ§å­è¿›ç¨‹æ•°é‡
ps aux | grep "Volatility_arbitrage_run" | wc -l

# ç›‘æ§ç­–ç•¥on_tické¢‘ç‡ï¼ˆä»æ—¥å¿—ï¼‰
tail -f logs/autorun/autorun_*.log | grep "updates=" | ts
```

### è´Ÿè½½æŠ¥è­¦é˜ˆå€¼
- **CPU > 80%ï¼š** è€ƒè™‘é™ä½å‘¨æœŸï¼ˆ5ç§’â†’7ç§’ï¼‰æˆ–å‡å°‘tokenæ•°é‡
- **å†…å­˜ > 85%ï¼š** æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜æ³„æ¼
- **APIé”™è¯¯ç‡ > 5%ï¼š** æ£€æŸ¥æ˜¯å¦è§¦å‘äº†rate limit

---

## ğŸ¯ å®æ–½å»ºè®®

### æ–¹æ¡ˆé€‰æ‹©çŸ©é˜µ

| ä½ çš„ç›®æ ‡ | æ¨èæ–¹æ¡ˆ | å‘¨æœŸè®¾ç½® | é¢„æœŸè´Ÿè½½ |
|---------|---------|---------|---------|
| è¿è¡Œ40+ä¸ªtokenï¼Œä¿å®ˆ | å¹³è¡¡æ–¹æ¡ˆ | 5ç§’ | +5% CPU |
| è¿è¡Œ20-40ä¸ªtokenï¼Œå¹³è¡¡ | æ¿€è¿›æ–¹æ¡ˆ | 2ç§’ | +10% CPU |
| è¿è¡Œ<20ä¸ªtokenï¼Œè¿½æ±‚æœ€ä¼˜ | æ™ºèƒ½è§¦å‘ | åŠ¨æ€ | +3-8% CPU |

### æ¸è¿›å¼æµ‹è¯•ç­–ç•¥

1. **ç¬¬ä¸€æ­¥ï¼š** å…ˆåº”ç”¨å¹³è¡¡æ–¹æ¡ˆï¼ˆ5ç§’ï¼‰
   - è§‚å¯Ÿ1å°æ—¶ï¼Œç›‘æ§CPUã€å†…å­˜ã€ä¸‹å•æƒ…å†µ
   - å¦‚æœè´Ÿè½½å¯æ¥å—ä¸”ä¸‹å•æœºä¼šå¢åŠ  â†’ æˆåŠŸ

2. **ç¬¬äºŒæ­¥ï¼š** å¦‚æœç¬¬ä¸€æ­¥æ•ˆæœå¥½ï¼Œå°è¯•æ¿€è¿›æ–¹æ¡ˆï¼ˆ2ç§’ï¼‰
   - è§‚å¯Ÿ30åˆ†é’Ÿï¼Œé‡ç‚¹ç›‘æ§CPUå³°å€¼
   - å¦‚æœCPU < 70% â†’ å¯ä»¥ç»§ç»­
   - å¦‚æœCPU > 80% â†’ å›é€€åˆ°5ç§’

3. **ç¬¬ä¸‰æ­¥ï¼š** å¦‚æœæƒ³ä¼˜åŒ–åˆ°æè‡´ï¼Œå®æ–½æ™ºèƒ½è§¦å‘æ–¹æ¡ˆ
   - éœ€è¦ä¿®æ”¹æ›´å¤šä»£ç ï¼ˆè§ä¸Šæ–‡ï¼‰
   - é€‚åˆé•¿æœŸè¿è¡Œ

---

## ğŸ’¡ å…¶ä»–ä¼˜åŒ–å»ºè®®

### 1. é™ä½æ—¥å¿—è¾“å‡ºé¢‘ç‡
```python
# åœ¨ Volatility_arbitrage_run.py ä¸­
# å°†æ—¥å¿—è¾“å‡ºé—´éš”ä»30ç§’æ”¹ä¸º60ç§’
if now - _apply_shared_ws_snapshot._last_debug_log >= 60:  # åŸæ¥æ˜¯30
```

### 2. ä¼˜åŒ–JSONè§£æ
```python
# åœ¨ poly_maker_autorun.py ä¸­
# å»æ‰ç¼©è¿›ï¼Œå‡å°‘æ–‡ä»¶å¤§å°å’Œå†™å…¥æ—¶é—´
json.dump(data, f, ensure_ascii=False)  # ç§»é™¤ indent=2
```

### 3. æ‰¹é‡å¤„ç†ï¼ˆé«˜çº§ï¼‰
å¦‚æœè¿è¡Œ100+ä¸ªtokenï¼Œè€ƒè™‘ï¼š
- å°†å¤šä¸ªtokenåˆ†ç»„ï¼Œæ¯ç»„å…±äº«ä¸€ä¸ªå­è¿›ç¨‹
- åœ¨å­è¿›ç¨‹å†…ç»´æŠ¤å¤šä¸ªç­–ç•¥å®ä¾‹
- å‡å°‘è¿›ç¨‹æ•°é‡ï¼Œé™ä½ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€

---

## ğŸ“‹ å¿«é€Ÿæ‰§è¡Œæ¸…å•

### ä¿å®ˆæ–¹æ¡ˆï¼ˆæ¨èå…ˆæ‰§è¡Œï¼‰
```bash
# 1. å¤‡ä»½
cp Volatility_arbitrage_run.py Volatility_arbitrage_run.py.bak

# 2. ä¿®æ”¹ä¸º5ç§’
sed -i '2722s/10\.0/5.0/' Volatility_arbitrage_run.py

# 3. é‡å¯å®ä¾‹
# (æ‰§è¡Œä½ çš„é‡å¯è„šæœ¬)

# 4. ç›‘æ§
tail -f logs/autorun/autorun_*.log | grep -E "updates=|CPU"
```

### éªŒè¯æ•ˆæœ
ä¿®å¤å30åˆ†é’Ÿï¼Œæ£€æŸ¥ï¼š
- âœ… updatesé¢‘ç‡æ˜¯å¦æå‡åˆ° 12/min å·¦å³
- âœ… ä¸‹å•æ¬¡æ•°æ˜¯å¦å¢åŠ 
- âœ… CPUä½¿ç”¨ç‡æ˜¯å¦åœ¨å¯æ¥å—èŒƒå›´ï¼ˆ<70%ï¼‰

---

## ğŸ”¬ A/Bæµ‹è¯•å»ºè®®

å¦‚æœä½ æƒ³ç§‘å­¦éªŒè¯æ•ˆæœï¼š

1. **å¯¹ç…§ç»„ï¼š** é€‰5ä¸ªtokenç”¨10ç§’å‘¨æœŸï¼ˆå½“å‰çŠ¶æ€ï¼‰
2. **å®éªŒç»„ï¼š** é€‰5ä¸ªtokenç”¨5ç§’å‘¨æœŸï¼ˆä¿®å¤åï¼‰
3. **è¿è¡Œ6å°æ—¶ï¼Œå¯¹æ¯”ï¼š**
   - ç­–ç•¥on_tickè°ƒç”¨æ¬¡æ•°
   - æ£€æµ‹åˆ°çš„ä¸‹å•ä¿¡å·æ¬¡æ•°
   - å®é™…æˆäº¤æ¬¡æ•°
   - å¹³å‡CPUä½¿ç”¨ç‡

---

## ç»“è®º

### æ¨èæ–¹æ¡ˆï¼š5ç§’å‘¨æœŸï¼ˆå¹³è¡¡æ–¹æ¡ˆï¼‰
- âœ… æ›´æ–°é¢‘ç‡æå‡6å€ï¼Œè¶³å¤Ÿæ•æ‰å¤§éƒ¨åˆ†ä¸‹å•æœºä¼š
- âœ… CPUè´Ÿè½½å¢åŠ é€‚ä¸­ï¼ˆçº¦5%ï¼‰ï¼Œèƒ½åŒæ—¶è¿è¡Œ40+ä¸ªtoken
- âœ… å®æ–½ç®€å•ï¼Œä¸€è¡Œä»£ç ä¿®æ”¹
- âœ… é£é™©ä½ï¼Œéšæ—¶å¯å›é€€

### å¦‚æœ5ç§’æ•ˆæœå¥½ä¸”è´Ÿè½½å¯æ¥å—
- å¯ä»¥å°è¯•é™ä½åˆ°3ç§’ç”šè‡³2ç§’
- æˆ–è€…å®æ–½æ™ºèƒ½è§¦å‘æ–¹æ¡ˆï¼ˆåŠ¨æ€è°ƒæ•´ï¼‰

### å…³é”®åŸåˆ™
**"å¤Ÿç”¨å°±å¥½"** - ä¸éœ€è¦è¿½æ±‚æè‡´çš„é«˜é¢‘æ›´æ–°ï¼Œåªè¦èƒ½å‡†ç¡®æ•æ‰åˆ°ä¸‹å•æœºä¼šå³å¯ã€‚5ç§’å‘¨æœŸåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å·²ç»è¶³å¤Ÿã€‚
