# ä¿®å¤å…±äº«WSæ¨¡å¼ä¸‹å•é¢‘ç‡ä½çš„è¡¥ä¸

## é—®é¢˜è¯Šæ–­
æ ¹æ®æ—¥å¿—åˆ†æï¼š
- WSèšåˆå™¨ï¼šæ¯åˆ†é’Ÿ4474æ¬¡æ›´æ–°ï¼ˆ40ä¸ªtokensï¼‰
- å­è¿›ç¨‹å®é™…ï¼šæ¯åˆ†é’Ÿ2æ¬¡æ›´æ–°ï¼ˆ30ç§’1æ¬¡ï¼‰
- **å·¨å¤§æ–­å±‚ï¼š** èšåˆå™¨çš„æ›´æ–°æ²¡æœ‰æœ‰æ•ˆä¼ é€’ç»™å­è¿›ç¨‹

## æ ¹æœ¬åŸå› 
1. seqåªåœ¨price_changeäº‹ä»¶æ—¶é€’å¢ï¼Œå…¶ä»–WSäº‹ä»¶è¢«å¿½ç•¥
2. å»é‡é€»è¾‘è¦æ±‚seqä¸å˜æ—¶ç­‰å¾…10ç§’æ‰å‘¨æœŸæ€§æ›´æ–°
3. å¯¼è‡´å³ä½¿æœ‰WSäº‹ä»¶æµï¼Œç­–ç•¥æ›´æ–°é¢‘ç‡ä¹Ÿæä½

---

## ä¿®å¤æ–¹æ¡ˆï¼ˆåˆ†çº§ï¼Œå¯é€æ­¥åº”ç”¨ï¼‰

### ğŸ”¥ æ–¹æ¡ˆ1ï¼šå¿«é€Ÿä¿®å¤ - é™ä½å»é‡å‘¨æœŸï¼ˆæ¨èç«‹å³åº”ç”¨ï¼‰

**å½±å“æ–‡ä»¶ï¼š**
- `POLYMARKET_MAKER_copytrade_v2/POLYMARKET_MAKER_AUTO/POLYMARKET_MAKER/Volatility_arbitrage_run.py`

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬2722è¡Œ

**ä¿®æ”¹å‰ï¼š**
```python
if time_since_last_tick >= 10.0:  # ä»5ç§’æ”¹ä¸º10ç§’ï¼Œé¿å…è¿‡äºé¢‘ç¹
    # å³ä½¿æ•°æ®ä¸å˜ï¼Œä¹Ÿå‘¨æœŸæ€§å–‚ç»™ç­–ç•¥ï¼ˆè®©æ¨ªç›˜ä»·æ ¼ä¹Ÿèƒ½ç´¯ç§¯å†å²ï¼‰
    should_feed_strategy = True
    if time_since_last_tick >= 30.0:  # è¶…è¿‡30ç§’æ‰æ‰“å°æ—¥å¿—
        print(f"[WS][SHARED] å¸‚åœºæ¨ªç›˜ {time_since_last_tick:.0f}ç§’ï¼Œå‘¨æœŸæ€§å–‚ä»·æ ¼ç»™ç­–ç•¥ (seq={seq})")
```

**ä¿®æ”¹åï¼š**
```python
if time_since_last_tick >= 2.0:  # âœ… æ”¹ä¸º2ç§’ï¼Œæé«˜ç­–ç•¥æ›´æ–°é¢‘ç‡
    # å³ä½¿æ•°æ®ä¸å˜ï¼Œä¹Ÿå‘¨æœŸæ€§å–‚ç»™ç­–ç•¥ï¼ˆè®©æ¨ªç›˜ä»·æ ¼ä¹Ÿèƒ½ç´¯ç§¯å†å²ï¼‰
    should_feed_strategy = True
    if time_since_last_tick >= 30.0:  # è¶…è¿‡30ç§’æ‰æ‰“å°æ—¥å¿—
        print(f"[WS][SHARED] å¸‚åœºæ¨ªç›˜ {time_since_last_tick:.0f}ç§’ï¼Œå‘¨æœŸæ€§å–‚ä»·æ ¼ç»™ç­–ç•¥ (seq={seq})")
```

**é¢„æœŸæ•ˆæœï¼š**
- æ›´æ–°é¢‘ç‡ä» 2.0/min æå‡åˆ°çº¦ 30/minï¼ˆæ¯2ç§’1æ¬¡ï¼‰
- 5åˆ†é’Ÿçª—å£å†…æ•°æ®ç‚¹ä»10ä¸ªå¢åŠ åˆ°150ä¸ª
- æ›´å‡†ç¡®åœ°æ•æ‰çŸ­æœŸæ³¢åŠ¨

**é£é™©ï¼š** ä½ã€‚åªæ˜¯æé«˜äº†å·²æœ‰çš„å‘¨æœŸæ€§æ›´æ–°é¢‘ç‡ã€‚

---

### ğŸ”¥ æ–¹æ¡ˆ2ï¼šä¼˜åŒ–seqæ›´æ–°æœºåˆ¶ï¼ˆæ ¹æœ¬æ€§è§£å†³ï¼‰

**å½±å“æ–‡ä»¶ï¼š**
- `POLYMARKET_MAKER_copytrade_v2/POLYMARKET_MAKER_AUTO/poly_maker_autorun.py`

**ä¿®æ”¹ä½ç½®1ï¼š** ç¬¬606-650è¡Œï¼ˆ`_on_ws_event` å‡½æ•°å¼€å¤´ï¼‰

**ä¿®æ”¹å‰ï¼š**
```python
def _on_ws_event(self, ev: Dict[str, Any]) -> None:
    # ç»Ÿè®¡äº‹ä»¶æ¥æ”¶å’Œè¿‡æ»¤æƒ…å†µ
    if not hasattr(self, '_ws_event_count'):
        self._ws_event_count = 0
        self._ws_filtered_count = 0
        self._ws_filtered_types: Dict[str, int] = {}
        self._ws_last_stats_log = 0.0

    self._ws_event_count += 1

    if self._ws_debug_raw:
        print(f"[WS][RAW] {ev}")

    # æ£€æŸ¥äº‹ä»¶ç±»å‹
    event_type = ev.get("event_type")
    if event_type != "price_change":
        # è®°å½•è¢«è¿‡æ»¤çš„äº‹ä»¶ç±»å‹
        self._ws_filtered_count += 1
        self._ws_filtered_types[event_type or "unknown"] = \
            self._ws_filtered_types.get(event_type or "unknown", 0) + 1

        # å®šæœŸæ‰“å°è¿‡æ»¤ç»Ÿè®¡ï¼ˆæ¯60ç§’ï¼‰
        now = time.time()
        if now - self._ws_last_stats_log >= 60:
            total_events = self._ws_event_count
            filtered_events = self._ws_filtered_count
            if total_events > 0:
                filtered_pct = (filtered_events / total_events) * 100
                print(f"[WS][AGGREGATOR] äº‹ä»¶è¿‡æ»¤ç»Ÿè®¡: æ€»è®¡={total_events}, "
                      f"è¿‡æ»¤={filtered_events} ({filtered_pct:.1f}%), "
                      f"ç±»å‹åˆ†å¸ƒ={dict(self._ws_filtered_types)}")
            self._ws_last_stats_log = now
            self._ws_event_count = 0
            self._ws_filtered_count = 0
            self._ws_filtered_types = {}

        # å¤„ç† last_trade_price æ›´æ–°ï¼ˆä»…æ—¶é—´æˆ³ï¼‰
        if event_type == "last_trade_price":
            self._on_ws_last_trade(ev)
        return  # âŒ è¿™é‡Œç›´æ¥returnï¼Œå¯¼è‡´å…¶ä»–äº‹ä»¶è¢«å¿½ç•¥
```

**ä¿®æ”¹åï¼š**
```python
def _on_ws_event(self, ev: Dict[str, Any]) -> None:
    # ç»Ÿè®¡äº‹ä»¶æ¥æ”¶å’Œè¿‡æ»¤æƒ…å†µ
    if not hasattr(self, '_ws_event_count'):
        self._ws_event_count = 0
        self._ws_processed_count = 0  # âœ… æ”¹åï¼šä»filteredæ”¹ä¸ºprocessed
        self._ws_event_types: Dict[str, int] = {}  # âœ… è®°å½•æ‰€æœ‰äº‹ä»¶ç±»å‹
        self._ws_last_stats_log = 0.0

    self._ws_event_count += 1

    if self._ws_debug_raw:
        print(f"[WS][RAW] {ev}")

    # æ£€æŸ¥äº‹ä»¶ç±»å‹
    event_type = ev.get("event_type")
    self._ws_event_types[event_type or "unknown"] = \
        self._ws_event_types.get(event_type or "unknown", 0) + 1

    # å®šæœŸæ‰“å°äº‹ä»¶ç»Ÿè®¡ï¼ˆæ¯60ç§’ï¼‰
    now = time.time()
    if now - self._ws_last_stats_log >= 60:
        total_events = self._ws_event_count
        processed_events = self._ws_processed_count
        if total_events > 0:
            processed_pct = (processed_events / total_events) * 100
            print(f"[WS][AGGREGATOR] äº‹ä»¶ç»Ÿè®¡: æ€»è®¡={total_events}, "
                  f"å·²å¤„ç†={processed_events} ({processed_pct:.1f}%), "
                  f"ç±»å‹åˆ†å¸ƒ={dict(self._ws_event_types)}")
        self._ws_last_stats_log = now
        self._ws_event_count = 0
        self._ws_processed_count = 0
        self._ws_event_types = {}

    # âœ… æ‰©å±•å¤„ç†çš„äº‹ä»¶ç±»å‹
    should_process = False
    lightweight_update = False  # æ˜¯å¦åªæ›´æ–°æ—¶é—´æˆ³

    if event_type == "price_change":
        should_process = True
        lightweight_update = False  # å®Œæ•´æ›´æ–°bid/ask/price
    elif event_type in ("book", "tick"):
        should_process = True
        lightweight_update = False  # ä¹Ÿå°è¯•ä»eventä¸­æå–bid/ask
    elif event_type == "last_trade_price":
        should_process = True
        lightweight_update = True  # åªæ›´æ–°æ—¶é—´æˆ³å’Œlast_trade_price

    if not should_process:
        return  # åªè¿‡æ»¤æ‰çœŸæ­£æ— ç”¨çš„äº‹ä»¶

    self._ws_processed_count += 1
```

**ä¿®æ”¹ä½ç½®2ï¼š** ç¬¬650-718è¡Œï¼ˆå¤„ç†é€»è¾‘ï¼‰

åœ¨ `price_changes` å¤„ç†ä¹‹åï¼Œæ·»åŠ å¯¹å…¶ä»–äº‹ä»¶çš„å¤„ç†ï¼š

```python
    # å¤„ç† price_change äº‹ä»¶ï¼ˆåŸæœ‰é€»è¾‘ä¿æŒä¸å˜ï¼‰
    if event_type == "price_change":
        pcs = ev.get("price_changes", [])
        if not isinstance(pcs, list):
            pcs = []
        # ... åŸæœ‰çš„å¤„ç†é€»è¾‘ ...

    # âœ… æ–°å¢ï¼šå¤„ç† book å’Œ tick äº‹ä»¶
    elif event_type in ("book", "tick"):
        # å°è¯•ä»eventæ ¹çº§åˆ«æå–ä»·æ ¼ä¿¡æ¯
        asset_id = ev.get("asset_id") or ev.get("token_id")
        if not asset_id:
            return

        token_id = str(asset_id)

        # æå–bid/ask
        bid = _coerce_float(ev.get("best_bid") or ev.get("bid"))
        ask = _coerce_float(ev.get("best_ask") or ev.get("ask"))
        last = _coerce_float(ev.get("last_price") or ev.get("price") or ev.get("mark_price"))

        if last is None and bid and ask:
            last = (bid + ask) / 2.0

        # åªæœ‰åœ¨æœ‰æœ‰æ•ˆä»·æ ¼æ—¶æ‰æ›´æ–°
        if not (bid or ask or last):
            return

        ts = _extract_ts(ev.get("timestamp") or ev.get("ts"))

        # é€’å¢seq
        with self._ws_cache_lock:
            old_data = self._ws_cache.get(token_id, {})
            seq = old_data.get("seq", 0) + 1

            payload = {
                "price": last or old_data.get("price", 0.0),
                "best_bid": bid or old_data.get("best_bid", 0.0),
                "best_ask": ask or old_data.get("best_ask", 0.0),
                "ts": ts,
                "updated_at": time.time(),
                "event_type": event_type,
                "seq": seq,
            }
            self._ws_cache[token_id] = payload
            self._ws_cache_dirty = True

    # âœ… æ–°å¢ï¼šå¤„ç† last_trade_price äº‹ä»¶ï¼ˆåªæ›´æ–°æ—¶é—´æˆ³ï¼‰
    elif event_type == "last_trade_price":
        self._on_ws_last_trade(ev)
```

**é¢„æœŸæ•ˆæœï¼š**
- seqæ›´æ–°é¢‘ç‡å¤§å¹…æå‡ï¼ˆä»åªä¾èµ–price_changeåˆ°æ”¯æŒbook/tickï¼‰
- å­è¿›ç¨‹èƒ½æ¥æ”¶åˆ°æ›´å¤šçš„ä»·æ ¼å˜åŒ–é€šçŸ¥
- æ›´æ¥è¿‘åŸç‰ˆæœ¬çš„é«˜é¢‘æ›´æ–°

**é£é™©ï¼š** ä¸­ã€‚éœ€è¦æµ‹è¯•book/tickäº‹ä»¶çš„æ•°æ®æ ¼å¼æ˜¯å¦ä¸price_changeä¸€è‡´ã€‚

---

### ğŸ”§ æ–¹æ¡ˆ3ï¼šå¢å¼ºå»é‡é€»è¾‘ï¼ˆç»“åˆupdated_atï¼‰

**å½±å“æ–‡ä»¶ï¼š**
- `POLYMARKET_MAKER_copytrade_v2/POLYMARKET_MAKER_AUTO/POLYMARKET_MAKER/Volatility_arbitrage_run.py`

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬2713-2732è¡Œ

**ä¿®æ”¹å‰ï¼š**
```python
elif seq == _apply_shared_ws_snapshot._last_seq:
    # seqç›¸åŒï¼Œæ£€æŸ¥updated_at
    if updated_at > _apply_shared_ws_snapshot._last_updated_at:
        # åŒä¸€seqä½†æ—¶é—´æˆ³å˜å¤§ï¼Œå¯èƒ½æ˜¯æ•°æ®ä¿®æ­£
        is_new_data = True
        should_feed_strategy = True
    else:
        # seqå’Œupdated_atéƒ½ä¸å˜ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦å‘¨æœŸæ€§å–‚ç»™ç­–ç•¥
        time_since_last_tick = now - _apply_shared_ws_snapshot._last_tick_ts
        if time_since_last_tick >= 10.0:
            should_feed_strategy = True
        else:
            _apply_shared_ws_snapshot._skip_count += 1
            return
```

**ä¿®æ”¹åï¼š**
```python
elif seq == _apply_shared_ws_snapshot._last_seq:
    # seqç›¸åŒï¼Œæ£€æŸ¥updated_at
    if updated_at > _apply_shared_ws_snapshot._last_updated_at:
        # åŒä¸€seqä½†æ—¶é—´æˆ³å˜å¤§ï¼Œå¯èƒ½æ˜¯æ•°æ®ä¿®æ­£
        is_new_data = True
        should_feed_strategy = True
    else:
        # âœ… å¢å¼ºé€»è¾‘ï¼šå³ä½¿updated_atä¸å˜ï¼Œå¦‚æœè·ç¦»ä¸Šæ¬¡æ›´æ–°ä¸åˆ°5ç§’ï¼Œä¹Ÿè€ƒè™‘å–‚ç»™ç­–ç•¥
        # è¿™æ ·å¯ä»¥æ•æ‰åˆ°èšåˆå™¨çš„lightweightæ›´æ–°ï¼ˆå¦‚last_trade_priceï¼‰
        time_since_last_update = now - _apply_shared_ws_snapshot._last_updated_at
        time_since_last_tick = now - _apply_shared_ws_snapshot._last_tick_ts

        if time_since_last_update <= 5.0 and time_since_last_tick >= 2.0:
            # æœ€è¿‘5ç§’å†…æœ‰æ›´æ–°ï¼ˆå³ä½¿updated_atå­—æ®µä¸å˜ï¼‰ï¼Œä¸”è·ä¸Šæ¬¡tickè¶…è¿‡2ç§’
            # è¯´æ˜å¯èƒ½æœ‰æ–°çš„WSäº‹ä»¶ï¼Œå–‚ç»™ç­–ç•¥
            should_feed_strategy = True
        elif time_since_last_tick >= 2.0:
            # è·ç¦»ä¸Šæ¬¡tickè¶…è¿‡2ç§’ï¼Œå‘¨æœŸæ€§å–‚ç»™ç­–ç•¥
            should_feed_strategy = True
        else:
            _apply_shared_ws_snapshot._skip_count += 1
            return
```

**é¢„æœŸæ•ˆæœï¼š**
- æ›´æ•æ„Ÿåœ°æ£€æµ‹ç¼“å­˜æ–‡ä»¶çš„å˜åŒ–
- å‡å°‘è¯¯åˆ¤ï¼ˆå°†æœ‰æ•ˆæ›´æ–°å½“æˆé‡å¤æ•°æ®ï¼‰

**é£é™©ï¼š** ä½ã€‚åªæ˜¯ä¼˜åŒ–åˆ¤æ–­é€»è¾‘ã€‚

---

## åº”ç”¨æ­¥éª¤

### å¿«é€ŸéªŒè¯ï¼ˆæ–¹æ¡ˆ1ï¼‰
1. å¤‡ä»½åŸæ–‡ä»¶ï¼š
   ```bash
   cp Volatility_arbitrage_run.py Volatility_arbitrage_run.py.bak
   ```

2. ä¿®æ”¹ç¬¬2722è¡Œï¼š
   ```bash
   sed -i 's/time_since_last_tick >= 10\.0/time_since_last_tick >= 2.0/g' \
       POLYMARKET_MAKER_copytrade_v2/POLYMARKET_MAKER_AUTO/POLYMARKET_MAKER/Volatility_arbitrage_run.py
   ```

3. é‡å¯è¿è¡Œå®ä¾‹ï¼Œè§‚å¯Ÿæ—¥å¿—ï¼š
   ```bash
   # æœŸæœ›çœ‹åˆ°ï¼šupdates=30 (30.0/min) æˆ–ç±»ä¼¼çš„æ›´é«˜é¢‘ç‡
   tail -f logs/autorun/autorun_*.log | grep "updates="
   ```

### å®Œæ•´ä¿®å¤ï¼ˆæ–¹æ¡ˆ1+2ï¼‰
1. åº”ç”¨æ–¹æ¡ˆ1ï¼ˆé™ä½å»é‡å‘¨æœŸï¼‰
2. åº”ç”¨æ–¹æ¡ˆ2ï¼ˆæ‰©å±•seqæ›´æ–°äº‹ä»¶ç±»å‹ï¼‰
3. é‡å¯autorunå’Œæ‰€æœ‰å­è¿›ç¨‹
4. å¯¹æ¯”ä¿®å¤å‰åçš„æ—¥å¿—

---

## éªŒè¯æŒ‡æ ‡

### ä¿®å¤å‰
```
[WS][SHARED] seq=20, updates=1 (2.0/min), bid=0.14, ask=0.17
çª—å£ä»·æ ¼(mid): é«˜ 0.6850 / ä½ 0.6850
çª—å£è·Œå¹…: å½“å‰ 0.00% / æœ€å¤§ 0.00% / é˜ˆå€¼ 0.10%
```

### ä¿®å¤åï¼ˆæœŸæœ›ï¼‰
```
[WS][SHARED] seq=25, updates=15 (30.0/min), bid=0.14, ask=0.17
çª—å£ä»·æ ¼(mid): é«˜ 0.6900 / ä½ 0.6800  â† èƒ½æ•æ‰åˆ°æ›´å¤šä»·æ ¼å˜åŒ–
çª—å£è·Œå¹…: å½“å‰ 0.50% / æœ€å¤§ 1.20% / é˜ˆå€¼ 0.10%  â† æ›´å‡†ç¡®çš„æ³¢åŠ¨è®¡ç®—
[STRATEGY] æ£€æµ‹åˆ°ä¸‹å•æ¡ä»¶: drop_ratio=1.2% >= threshold=0.1%
```

---

## å›æ»šæ–¹æ¡ˆ
å¦‚æœä¿®å¤åå‡ºç°é—®é¢˜ï¼š

```bash
# æ–¹æ¡ˆ1å›æ»š
cp Volatility_arbitrage_run.py.bak Volatility_arbitrage_run.py

# æ–¹æ¡ˆ2å›æ»š
git checkout poly_maker_autorun.py
```

---

## é¢„æœŸæ•ˆæœæ€»ç»“

| æ–¹æ¡ˆ | æ›´æ–°é¢‘ç‡æå‡ | ä¸‹å•æœºä¼šå¢åŠ  | å®æ–½éš¾åº¦ | é£é™© |
|------|-------------|-------------|---------|------|
| æ–¹æ¡ˆ1 | 15å€ï¼ˆ2â†’30/minï¼‰ | æ˜¾è‘—å¢åŠ  | ç®€å• | ä½ |
| æ–¹æ¡ˆ2 | å–å†³äºWSäº‹ä»¶åˆ†å¸ƒ | æ ¹æœ¬æ€§æ”¹å–„ | ä¸­ç­‰ | ä¸­ |
| æ–¹æ¡ˆ3 | é…åˆæ–¹æ¡ˆ1/2 | å‡å°‘è¯¯åˆ¤ | ç®€å• | ä½ |

**æ¨èï¼š** å…ˆåº”ç”¨æ–¹æ¡ˆ1è¿›è¡Œå¿«é€ŸéªŒè¯ï¼Œå¦‚æœæ•ˆæœæ˜¾è‘—ï¼Œå†è€ƒè™‘åº”ç”¨æ–¹æ¡ˆ2è¿›è¡Œæ ¹æœ¬æ€§ä¼˜åŒ–ã€‚

---

## åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### æ€§èƒ½ä¼˜åŒ–
1. ç§»é™¤JSONçš„ `indent=2`ï¼Œå‡å°‘æ–‡ä»¶å¤§å°ï¼š
   ```python
   json.dump(data, f, ensure_ascii=False)  # ä¸è¦indentå‚æ•°
   ```

2. ä½¿ç”¨msgpackæ›¿ä»£JSONï¼ˆæ›´å¿«çš„åºåˆ—åŒ–ï¼‰

### ç›‘æ§ä¼˜åŒ–
1. æ·»åŠ è¯¦ç»†çš„äº‹ä»¶ç±»å‹ç»Ÿè®¡æ—¥å¿—
2. ç›‘æ§seqé€’å¢é¢‘ç‡
3. ç›‘æ§å»é‡é€»è¾‘çš„skip_count

### æ¶æ„ä¼˜åŒ–ï¼ˆé•¿æœŸï¼‰
è€ƒè™‘å¼•å…¥Redisæˆ–å…±äº«å†…å­˜ï¼Œæ›¿ä»£æ–‡ä»¶ç¼“å­˜ï¼Œè¿›ä¸€æ­¥é™ä½å»¶è¿Ÿã€‚
