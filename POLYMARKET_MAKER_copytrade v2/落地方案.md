# POLYMARKET_MAKER_copytrade v2 代码落地方案

## 目标
1. 移除 `POLYMARKET_MAKER_AUTO` 原版全市场筛选 topics 的逻辑，仅保留 maker 波段交易与调度能力。
2. 迁移 `POLYMARKET_MAKER_copytrade` 中“筛选话题”的模块到 `POLYMARKET_MAKER_copytrade v2/copytrade`。
3. 新增 v2 入口脚本：先运行 copytrade 侧脚本拿到跟单 tokens，再将 tokens 交给 maker 波段交易脚本执行。

## 方案拆解

### 1) 移除 auto 的 topics 筛选逻辑
**涉及位置（基于现有目录结构）：**
- `POLYMARKET_MAKER_copytrade v2/POLYMARKET_MAKER_AUTO/poly_maker_autorun.py`
- `POLYMARKET_MAKER_copytrade v2/POLYMARKET_MAKER_AUTO/Customize_fliter_blacklist.py`
- `POLYMARKET_MAKER_copytrade v2/POLYMARKET_MAKER_AUTO/POLYMARKET_MAKER/config/filter_params.json`

**调整点：**
- `poly_maker_autorun.py` 中所有“筛选输出 -> topics 列表”的流程不再使用：
  - 去掉 `run_filter_once()` 调用与 `filter_output_path` 依赖。
  - 去掉 `compute_new_topics()` 的“筛选结果 vs handled_topics”逻辑。
  - `pending_topics` 的生成改为外部注入（由 copytrade 产出 tokens）。
- `Customize_fliter_blacklist.py` 保留在仓库中，但在 v2 流程中不再被入口脚本调用。

> 目标是把 auto 侧的职责收敛为：**接受 token/topic 列表 + 策略配置 → 启动/停止 maker 波段交易任务**。

### 2) 迁移 copytrade 的话题筛选模块
**来源（旧版本）：**
- `POLYMARKET_MAKER_copytrade/modules/topic_selector.py`
- `POLYMARKET_MAKER_copytrade/modules/signal_tracker.py`

**落地到 v2：**
- 在 `POLYMARKET_MAKER_copytrade v2/copytrade` 内新建 `modules/` 目录。
- 复制 `topic_selector.py` 与 `signal_tracker.py`，保留 `Topic` 数据结构与 `select_topics()` 的筛选逻辑。
- 如 v2 copytrade 入口脚本尚不存在，新增 `copytrade_runner.py`（或等价脚本），用于订阅/轮询目标账户信号，并输出 tokens 或 Topic 列表。

**注意点：**
- 若 v2 copytrade 仅需要 token 列表，可在 `signal_tracker.py` 中增加导出函数，将 `Topic` 映射为 `token_id`/`token_key`。
- 复制后统一相对 import 路径（例如 `from .topic_selector import Topic`）。

### 3) 新增 v2 入口脚本（copytrade → maker 调度）
**目标文件：**
- `POLYMARKET_MAKER_copytrade v2/run_copytrade_maker.py`

**职责：**
1. 启动 `copytrade` 脚本（或直接导入调用）并获取跟单信号产出的 tokens。
2. 将 tokens 转换为 maker 侧可消费的 topic_id / token_id 格式。
3. 调用 `POLYMARKET_MAKER_AUTO` 的 maker 波段交易脚本（或其调度器接口）启动交易。

**建议的实现路径：**
- **方式 A：直接 import 调度器**
  - 在 `run_copytrade_maker.py` 内 import `poly_maker_autorun.py` 中的调度器类，提供 `start_topics(tokens)` 的接口。
  - 由 copytrade 信号触发 `start_topics()` / `stop_topics()`。
- **方式 B：子进程调用**
  - copytrade 输出 token 列表到 JSON（例如 `data/copytrade_topics.json`）。
  - `run_copytrade_maker.py` 调用 `POLYMARKET_MAKER_AUTO` 的主脚本，传入该 JSON 路径作为“输入 topics”。

**输出/接口建议：**
- `copytrade` 输出结构建议：
  ```json
  {
    "timestamp": "2024-xx-xxT00:00:00Z",
    "topics": [
      {"token_id": "...", "token_key": "...", "condition_id": "...", "outcome_index": 0}
    ]
  }
  ```
- maker 侧读取 `topics` 字段，启动对应波段交易任务。

## 实施顺序建议
1. 在 v2/copytrade 下创建 `modules/` 并迁移筛选逻辑。
2. 在 auto 侧改造 `poly_maker_autorun.py`：移除筛选调用、开放外部注入 topics。
3. 新增 `run_copytrade_maker.py`，打通 copytrade → maker 的 token 流。
4. 通过 mock tokens 验证 maker 侧能正常启动/停止任务。

## 交付物清单
- `POLYMARKET_MAKER_copytrade v2/落地方案.md`（本文件）
- v2 copytrade 侧筛选模块迁移
- v2 自动化调度脚本改造
- v2 入口编排脚本
