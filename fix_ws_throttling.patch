# 修复新版本下单频率低的问题 - 补丁文件

## 问题描述
新版本在独立WS模式下误加了60秒的事件处理限流，导致策略响应极慢，错过大量下单机会。

## 影响文件
- POLYMARKET_MAKER_copytrade_v2/POLYMARKET_MAKER_AUTO/POLYMARKET_MAKER/Volatility_arbitrage_run.py

## 修复内容

### 修复1：移除独立WS模式的60秒限流 (关键修复)

**位置：** Volatility_arbitrage_run.py 第2462-2519行

**修改前：**
```python
    last_event_processed_ts = 0.0

    def _on_event(ev: Dict[str, Any]):
        nonlocal market_closed_detected, last_event_processed_ts, last_signal_ts
        if stop_event.is_set():
            return
        if not isinstance(ev, dict):
            return
        if _event_indicates_market_closed(ev):
            print("[MARKET] 收到市场关闭事件，准备退出…")
            market_closed_detected = True
            strategy.stop("market closed")
            stop_event.set()
            return

        if ev.get("event_type") == "price_change":
            pcs = ev.get("price_changes", [])
        elif "price_changes" in ev:
            pcs = ev.get("price_changes", [])
        else:
            return
        ts = _extract_ts(ev.get("timestamp") or ev.get("ts") or ev.get("time"))
        with ws_state_lock:
            ws_state["last_event_ts"] = time.time()
        now = time.time()
        if now - last_event_processed_ts < 60.0:  # ❌ 这里是问题
            return
        last_event_processed_ts = now
```

**修改后：**
```python
    def _on_event(ev: Dict[str, Any]):
        nonlocal market_closed_detected, last_signal_ts
        if stop_event.is_set():
            return
        if not isinstance(ev, dict):
            return
        if _event_indicates_market_closed(ev):
            print("[MARKET] 收到市场关闭事件，准备退出…")
            market_closed_detected = True
            strategy.stop("market closed")
            stop_event.set()
            return

        if ev.get("event_type") == "price_change":
            pcs = ev.get("price_changes", [])
        elif "price_changes" in ev:
            pcs = ev.get("price_changes", [])
        else:
            return
        ts = _extract_ts(ev.get("timestamp") or ev.get("ts") or ev.get("time"))
        with ws_state_lock:
            ws_state["last_event_ts"] = time.time()

        # ✅ 移除了60秒限流逻辑，恢复原版本的实时处理行为
```

**说明：**
1. 删除 `last_event_processed_ts` 变量声明（第2462行）
2. 删除 `_on_event` 函数中的限流检查（第2487-2489行）
3. 从 `nonlocal` 声明中移除 `last_event_processed_ts`

---

### 修复2：优化共享WS模式的周期性更新间隔 (可选优化)

**位置：** Volatility_arbitrage_run.py 第2720-2732行

**修改前：**
```python
        elif seq == _apply_shared_ws_snapshot._last_seq:
            # seq相同，检查updated_at
            if updated_at > _apply_shared_ws_snapshot._last_updated_at:
                # 同一seq但时间戳变大，可能是数据修正
                is_new_data = True
                should_feed_strategy = True
            else:
                # seq和updated_at都不变，检查是否需要周期性喂给策略
                time_since_last_tick = now - _apply_shared_ws_snapshot._last_tick_ts
                if time_since_last_tick >= 10.0:  # ⚠️ 10秒太长
                    # 即使数据不变，也周期性喂给策略（让横盘价格也能累积历史）
                    should_feed_strategy = True
```

**修改后：**
```python
        elif seq == _apply_shared_ws_snapshot._last_seq:
            # seq相同，检查updated_at
            if updated_at > _apply_shared_ws_snapshot._last_updated_at:
                # 同一seq但时间戳变大，可能是数据修正
                is_new_data = True
                should_feed_strategy = True
            else:
                # seq和updated_at都不变，检查是否需要周期性喂给策略
                time_since_last_tick = now - _apply_shared_ws_snapshot._last_tick_ts
                if time_since_last_tick >= 2.0:  # ✅ 从10秒改为2秒，提高响应速度
                    # 即使数据不变，也周期性喂给策略（让横盘价格也能累积历史）
                    should_feed_strategy = True
```

**说明：**
将周期性更新间隔从10秒降低到2秒，提高横盘市场下的策略更新频率。

---

## 应用补丁步骤

### 手动修改（推荐）
1. 打开文件：
   ```bash
   cd /home/user/POLYMARKET_MAKER_copytrade
   vim POLYMARKET_MAKER_copytrade_v2/POLYMARKET_MAKER_AUTO/POLYMARKET_MAKER/Volatility_arbitrage_run.py
   ```

2. 找到第2462行，删除：
   ```python
   last_event_processed_ts = 0.0
   ```

3. 找到第2465行的 `_on_event` 函数定义，修改 `nonlocal` 声明：
   ```python
   # 修改前：
   nonlocal market_closed_detected, last_event_processed_ts, last_signal_ts

   # 修改后：
   nonlocal market_closed_detected, last_signal_ts
   ```

4. 找到第2487-2489行，删除以下代码块：
   ```python
   now = time.time()
   if now - last_event_processed_ts < 60.0:
       return
   last_event_processed_ts = now
   ```

5. （可选）找到第2722行，修改周期更新间隔：
   ```python
   # 修改前：
   if time_since_last_tick >= 10.0:

   # 修改后：
   if time_since_last_tick >= 2.0:
   ```

6. 保存并退出

### 验证修改
修改后，检查以下几点：
1. 独立WS模式的日志应该显示更频繁的 `[WS][INDEPENDENT] events=...` 输出
2. 策略 `on_tick` 调用频率应该显著提升
3. 下单机会应该增加

---

## 测试建议

### 1. 对比测试
使用相同的token在修改前后分别运行，对比：
- 策略 `on_tick` 调用次数
- 实际下单次数
- 从价格变化到下单的延迟

### 2. 日志监控
查看日志中的关键指标：
```bash
# 查看WS事件接收频率
grep "\[WS\]\[INDEPENDENT\]" logs/autorun/autorun_*.log | tail -20

# 查看策略信号触发
grep "BUY\|SELL" logs/autorun/autorun_*.log | grep -v "COUNTDOWN"
```

### 3. 性能监控
修改后，如果出现CPU或I/O过高，可以：
- 调整日志输出频率（修改第2505行的30秒间隔）
- 增加轻微的限流（如0.5-1秒，而非60秒）

---

## 回滚方案
如果修改后出现问题，可以：
1. 从 `POLYMARKET_MAKER_copytrade_v2_原版参考` 目录复制原文件
2. 或使用 git 回滚（如果有版本控制）

---

## 预期效果

### 修复前
- 独立WS模式：60秒处理一次事件，极低频率
- 共享WS模式：10秒更新一次，低频率
- 下单机会：极少

### 修复后
- 独立WS模式：实时处理每个事件，高频率
- 共享WS模式：2秒更新一次，中高频率
- 下单机会：显著增加

**预计下单频率可提升 10-50 倍（取决于市场波动情况）**
