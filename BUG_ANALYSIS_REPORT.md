# POLYMARKET_MAKER_copytrade_v2 BUG åˆ†ææŠ¥å‘Š

## æ‰§è¡Œæ—¶é—´
2026-01-19

## é—®é¢˜æ¦‚è¿°
ç¨‹åºåœ¨ VPS ä¸Šè¿è¡Œä¸€å¤©ä½†å§‹ç»ˆä¸ä¸‹å•ã€‚ç»è¿‡ä»£ç å®¡æŸ¥ï¼Œå‘ç°å¤šä¸ªä¸¥é‡çš„é€»è¾‘é—®é¢˜å¯¼è‡´ç³»ç»Ÿæ— æ³•æ­£å¸¸å·¥ä½œã€‚

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ 1: é¦–æ¬¡è¿è¡Œæ—¶è·³è¿‡æ‰€æœ‰å†å²äº¤æ˜“

### ä½ç½®
`copytrade/copytrade_run.py` ç¬¬ 289-297 è¡Œ

### é—®é¢˜ä»£ç 
```python
since_ms = int(target_state.get("last_timestamp_ms") or 0)
if since_ms <= 0:
    init_ms = now_ms
    state["targets"][account] = {
        "last_timestamp_ms": init_ms,
        "updated_at": _utc_now_iso(),
    }
    logger.info("åˆå§‹åŒ–ç›®æ ‡è´¦æˆ·çŠ¶æ€,å¿½ç•¥å·²æœ‰ä»“ä½: account=%s", account)
    continue  # âš ï¸ è¿™é‡Œç›´æ¥è·³è¿‡ï¼Œä¸è·å–ä»»ä½•äº¤æ˜“ï¼
```

### é—®é¢˜åˆ†æ
1. **é¦–æ¬¡è¿è¡Œæ—¶çš„è‡´å‘½é€»è¾‘é”™è¯¯**ï¼š
   - å½“ `copytrade_state.json` ä¸ºç©ºæ—¶ï¼Œ`since_ms` ä¸º 0
   - ä»£ç å°† `last_timestamp_ms` è®¾ç½®ä¸º"å½“å‰æ—¶é—´"
   - **ç„¶åç«‹å³ `continue`ï¼Œè·³è¿‡äº¤æ˜“è·å–**

2. **åç»­è¿è¡Œçš„é—®é¢˜**ï¼š
   - ç¬¬äºŒæ¬¡å¾ªç¯æ—¶ï¼Œ`since_ms` å·²ç»æ˜¯"å½“å‰æ—¶é—´"
   - åªä¼šè·å–"æœªæ¥"å‘ç”Ÿçš„äº¤æ˜“
   - **è·Ÿå•è´¦æˆ·çš„æ‰€æœ‰å†å²ä»“ä½æ°¸è¿œä¸ä¼šè¢«æ•è·**

3. **å®é™…å½±å“**ï¼š
   - å¦‚æœè·Ÿå•è´¦æˆ·åœ¨ç¨‹åºå¯åŠ¨å‰å·²ç»æœ‰ä»“ä½ï¼ˆè¿™æ˜¯å¤§æ¦‚ç‡æƒ…å†µï¼‰
   - è¿™äº›ä»“ä½**æ°¸è¿œä¸ä¼šè¢«ç³»ç»Ÿå‘ç°**
   - ç³»ç»Ÿåªä¼šç­‰å¾…"æ–°"äº¤æ˜“ï¼Œä½†å¯èƒ½å¾ˆé•¿æ—¶é—´éƒ½æ²¡æœ‰æ–°äº¤æ˜“
   - **è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸€å¤©éƒ½ä¸ä¸‹å•çš„æ ¹æœ¬åŸå› **

### ä¿®å¤å»ºè®®
é¦–æ¬¡è¿è¡Œæ—¶åº”è¯¥ï¼š
1. è®¾ç½®ä¸€ä¸ªåˆç†çš„å›æº¯æ—¶é—´ï¼ˆæ¯”å¦‚æœ€è¿‘ 24 å°æ—¶ï¼‰
2. è·å–å†å²äº¤æ˜“å¹¶å¤„ç†
3. ç„¶åå†æ›´æ–° `last_timestamp_ms`

æˆ–è€…æ›´ç®€å•çš„æ–¹æ³•ï¼š
- åˆ é™¤ `continue` è¯­å¥ï¼Œè®©é¦–æ¬¡è¿è¡Œä¹Ÿè·å–äº¤æ˜“
- æˆ–è€…å°†åˆå§‹æ—¶é—´è®¾ç½®ä¸º `now_ms - (3600 * 1000)`ï¼ˆ1å°æ—¶å‰ï¼‰

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ 2: tokens_from_copytrade.json å§‹ç»ˆä¸ºç©º

### å½“å‰çŠ¶æ€
```json
{
  "updated_at": null,
  "tokens": []
}
```

### åŸå› åˆ†æ
1. **é—®é¢˜ 1 å¯¼è‡´æ²¡æœ‰äº¤æ˜“è¢«å¤„ç†**
   - `copytrade_run.py` ä»æœªæˆåŠŸæŠ“å–åˆ°äº¤æ˜“
   - å› æ­¤ `tokens` æ•°ç»„å§‹ç»ˆä¸ºç©º

2. **è¿é”ååº”**ï¼š
   - `poly_maker_autorun.py` è¯»å– `tokens_from_copytrade.json`
   - å‘ç° `tokens` ä¸ºç©ºæ•°ç»„
   - æ²¡æœ‰æ–°çš„ topic éœ€è¦å¤„ç†
   - **æ°¸è¿œä¸ä¼šå¯åŠ¨ä»»ä½• maker è¿›ç¨‹**
   - **æ°¸è¿œä¸ä¼šä¸‹å•**

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ 3: copytrade_state.json ä¸ºç©º

### å½“å‰çŠ¶æ€
```json
{
  "targets": {}
}
```

### é—®é¢˜åˆ†æ
1. **çŠ¶æ€æ–‡ä»¶ä¸ºç©º**æ„å‘³ç€ä¸¤ç§å¯èƒ½ï¼š
   - ç¨‹åºä»æœªæˆåŠŸè¿è¡Œè¿‡
   - çŠ¶æ€æ–‡ä»¶è¢«æ‰‹åŠ¨æ¸…ç©ºæˆ–åˆ é™¤

2. **å¦‚æœç¨‹åºè¿è¡Œè¿‡ä½†çŠ¶æ€ä¸ºç©º**ï¼š
   - è¯´æ˜ç¨‹åºåœ¨åˆå§‹åŒ–åç«‹å³é€€å‡ºæˆ–å´©æºƒ
   - æˆ–è€…çŠ¶æ€æ–‡ä»¶å†™å…¥å¤±è´¥

---

## ğŸŸ¡ æ½œåœ¨é—®é¢˜ 4: API è¯·æ±‚å¯èƒ½å¤±è´¥ä½†æ— é”™è¯¯å¤„ç†

### ä½ç½®
`copytrade/copytrade_run.py` ç¬¬ 211-249 è¡Œ

### é—®é¢˜åˆ†æ
```python
def _collect_trades(
    client: DataApiClient,
    account: str,
    since_ms: int,
    min_size: float,
    logger: logging.Logger,
) -> Tuple[List[Dict[str, Any]], int]:
    start_dt = datetime.fromtimestamp(max(since_ms, 0) / 1000.0, tz=timezone.utc)
    trades = client.fetch_trades(account, start_time=start_dt, page_size=500, max_pages=5)
    # ... å¤„ç†äº¤æ˜“
```

**é—®é¢˜**ï¼š
- `fetch_trades` å¯èƒ½è¿”å›ç©ºåˆ—è¡¨ï¼ˆAPI å¤±è´¥ã€ç½‘ç»œé—®é¢˜ã€è´¦æˆ·ä¸å­˜åœ¨ç­‰ï¼‰
- ä½†ä»£ç æ²¡æœ‰åŒºåˆ†"API å¤±è´¥"å’Œ"ç¡®å®æ²¡æœ‰äº¤æ˜“"
- å¦‚æœ API ä¸€ç›´å¤±è´¥ï¼Œç³»ç»Ÿä¼šè®¤ä¸º"æ²¡æœ‰æ–°äº¤æ˜“"è€Œä¸æŠ¥é”™

### API å®¢æˆ·ç«¯åˆ†æ
`smartmoney_query/api_client.py` ç¬¬ 93-105 è¡Œï¼š
```python
try:
    resp = self.session.get(url, params=params, timeout=self.timeout)
    resp.raise_for_status()
    payload = resp.json()
except Exception as exc:
    logger.warning(
        "fetch_trades request failed: user=%s offset=%s page_size=%s error=%s",
        user,
        offset,
        page_size,
        exc,
    )
    break  # ç›´æ¥ breakï¼Œè¿”å›ç©ºåˆ—è¡¨
```

**é—®é¢˜**ï¼š
- å¦‚æœ API å¤±è´¥ï¼Œåªæ˜¯ `logger.warning` ç„¶åè¿”å›ç©ºåˆ—è¡¨
- è°ƒç”¨æ–¹æ— æ³•çŸ¥é“æ˜¯"çœŸçš„æ²¡æœ‰äº¤æ˜“"è¿˜æ˜¯"API å¤±è´¥äº†"

---

## ğŸŸ¡ æ½œåœ¨é—®é¢˜ 5: æ²¡æœ‰æ—¥å¿—æ–‡ä»¶

### è§‚å¯Ÿ
- `copytrade/logs/` ç›®å½•ä¸å­˜åœ¨
- æ‰¾ä¸åˆ°ä»»ä½• copytrade ç›¸å…³çš„æ—¥å¿—æ–‡ä»¶

### é—®é¢˜åˆ†æ
1. **å¯èƒ½åŸå› **ï¼š
   - ç¨‹åºä»æœªè¿è¡Œè¿‡
   - ç¨‹åºåœ¨åˆ›å»ºæ—¥å¿—ç›®å½•å‰å°±å´©æºƒäº†
   - æ—¥å¿—è·¯å¾„é…ç½®é”™è¯¯

2. **å»ºè®®**ï¼š
   - æ£€æŸ¥ç¨‹åºæ˜¯å¦å®é™…åœ¨è¿è¡Œ
   - æ£€æŸ¥æ˜¯å¦æœ‰å¯åŠ¨è„šæœ¬
   - æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ï¼ˆsystemd/supervisor ç­‰ï¼‰

---

## ğŸŸ¡ æ½œåœ¨é—®é¢˜ 6: é…ç½®ä¸­çš„è´¦æˆ·å¯èƒ½æ— æ•ˆ

### å½“å‰é…ç½®
`copytrade/copytrade_config.json`:
```json
{
  "poll_interval_sec": 60,
  "initial_lookback_sec": 3600,
  "targets": [
    {
      "account": "0x96489abcb9f583d6835c8ef95ffc923d05a86825",
      "min_size": 5.0,
      "enabled": true
    },
    {
      "account": "0x9ca119b8cd7bdb890aecf1ff3b0f6e3a45cc13b5",
      "min_size": 5.0,
      "enabled": true
    }
  ]
}
```

### éœ€è¦éªŒè¯
1. è¿™ä¸¤ä¸ªåœ°å€æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ Polymarket è´¦æˆ·ï¼Ÿ
2. è¿™ä¸¤ä¸ªè´¦æˆ·æ˜¯å¦æœ‰è¶³å¤Ÿçš„äº¤æ˜“å†å²ï¼Ÿ
3. è¿™ä¸¤ä¸ªè´¦æˆ·çš„äº¤æ˜“æ˜¯å¦æ»¡è¶³ `min_size >= 5.0` çš„æ¡ä»¶ï¼Ÿ
4. API æ˜¯å¦èƒ½æ­£å¸¸è®¿é—®è¿™äº›è´¦æˆ·çš„æ•°æ®ï¼Ÿ

---

## ğŸŸ¡ æ½œåœ¨é—®é¢˜ 7: token_id æå–é€»è¾‘å¤æ‚ä¸”å®¹æ˜“å¤±è´¥

### ä½ç½®
`copytrade/copytrade_run.py` ç¬¬ 79-127 è¡Œ

### é—®é¢˜åˆ†æ
```python
def _normalize_trade(trade: Any) -> Optional[Dict[str, Any]]:
    # ... çœç•¥ side å’Œ size æ£€æŸ¥

    raw = getattr(trade, "raw", {}) or {}
    token_id = (
        raw.get("tokenId")
        or raw.get("token_id")
        or raw.get("clobTokenId")
        # ... å¤šè¾¾ 8 ä¸ªä¸åŒçš„å­—æ®µå
    )
    if token_id is None:
        token_id = _deep_find_first(raw, (...), )  # é€’å½’æœç´¢
    if token_id is None:
        return None  # âš ï¸ å¦‚æœæ‰¾ä¸åˆ° token_idï¼Œæ•´ä¸ªäº¤æ˜“è¢«ä¸¢å¼ƒ
```

**é—®é¢˜**ï¼š
- API è¿”å›çš„æ•°æ®ç»“æ„å¯èƒ½ä¸é¢„æœŸä¸ç¬¦
- å¦‚æœå­—æ®µåä¸åŒ¹é…ï¼Œäº¤æ˜“ä¼šè¢«ä¸¢å¼ƒ
- æ²¡æœ‰æ—¥å¿—è®°å½•ä¸ºä»€ä¹ˆäº¤æ˜“è¢«ä¸¢å¼ƒ

---

## ğŸŸ¢ é€»è¾‘é—®é¢˜ 8: é…ç½®ä¸­çš„ initial_lookback_sec æœªä½¿ç”¨

### ä½ç½®
`copytrade/copytrade_config.json` ç¬¬ 3 è¡Œï¼š
```json
"initial_lookback_sec": 3600,
```

### é—®é¢˜åˆ†æ
- é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº† `initial_lookback_sec: 3600`ï¼ˆ1å°æ—¶å›æº¯ï¼‰
- **ä½†ä»£ç ä¸­ä»æœªè¯»å–æˆ–ä½¿ç”¨è¿™ä¸ªå‚æ•°**
- é¦–æ¬¡è¿è¡Œæ—¶ç¡¬ç¼–ç ä½¿ç”¨ `now_ms`ï¼ˆå½“å‰æ—¶é—´ï¼‰
- è¿™ä¸ªé…ç½®é¡¹å®Œå…¨æ— æ•ˆ

### ä¿®å¤å»ºè®®
åœ¨ `run_once` å‡½æ•°ä¸­ï¼š
```python
if since_ms <= 0:
    lookback_sec = float(config.get("initial_lookback_sec", 3600))
    init_ms = now_ms - int(lookback_sec * 1000)  # ä½¿ç”¨å›æº¯æ—¶é—´
    # ... ç»§ç»­å¤„ç†
```

---

## ğŸ“Š é—®é¢˜æ€»ç»“

| é—®é¢˜ç­‰çº§ | é—®é¢˜æè¿° | å½±å“ | ä¼˜å…ˆçº§ |
|---------|---------|------|--------|
| ğŸ”´ ä¸¥é‡ | é¦–æ¬¡è¿è¡Œæ—¶ continue è·³è¿‡äº¤æ˜“è·å– | æ— æ³•æ•è·å†å²ä»“ä½ | **æœ€é«˜** |
| ğŸ”´ ä¸¥é‡ | tokens_from_copytrade.json ä¸ºç©º | ä¸‹æ¸¸ç³»ç»Ÿæ— æ³•å¯åŠ¨ | **æœ€é«˜** |
| ğŸ”´ ä¸¥é‡ | copytrade_state.json ä¸ºç©º | ç³»ç»ŸçŠ¶æ€å¼‚å¸¸ | **æœ€é«˜** |
| ğŸŸ¡ ä¸­ç­‰ | API å¤±è´¥æ— æ³•åŒºåˆ† | å¯èƒ½è¯¯åˆ¤ä¸ºæ— äº¤æ˜“ | é«˜ |
| ğŸŸ¡ ä¸­ç­‰ | æ²¡æœ‰æ—¥å¿—æ–‡ä»¶ | æ— æ³•è¯Šæ–­é—®é¢˜ | é«˜ |
| ğŸŸ¡ ä¸­ç­‰ | è´¦æˆ·å¯èƒ½æ— æ•ˆ | æ— æ³•è·å–æ•°æ® | é«˜ |
| ğŸŸ¡ ä¸­ç­‰ | token_id æå–é€»è¾‘å¤æ‚ | äº¤æ˜“å¯èƒ½è¢«ä¸¢å¼ƒ | ä¸­ |
| ğŸŸ¢ è¾ƒå° | initial_lookback_sec æœªä½¿ç”¨ | é…ç½®æ— æ•ˆ | ä½ |

---

## ğŸ”§ ç«‹å³è¡ŒåŠ¨å»ºè®®

### 1. ä¿®å¤æ ¸å¿ƒé€»è¾‘ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

**ä¿®æ”¹ `copytrade/copytrade_run.py` ç¬¬ 289-297 è¡Œ**ï¼š

```python
# ä¿®æ”¹å‰
if since_ms <= 0:
    init_ms = now_ms
    state["targets"][account] = {
        "last_timestamp_ms": init_ms,
        "updated_at": _utc_now_iso(),
    }
    logger.info("åˆå§‹åŒ–ç›®æ ‡è´¦æˆ·çŠ¶æ€ï¼Œå¿½ç•¥å·²æœ‰ä»“ä½: account=%s", account)
    continue  # âš ï¸ åˆ é™¤è¿™ä¸€è¡Œï¼

# ä¿®æ”¹åï¼ˆæ–¹æ¡ˆ 1ï¼šä½¿ç”¨é…ç½®çš„å›æº¯æ—¶é—´ï¼‰
if since_ms <= 0:
    lookback_sec = float(config.get("initial_lookback_sec", 3600))
    since_ms = now_ms - int(lookback_sec * 1000)
    logger.info("åˆå§‹åŒ–ç›®æ ‡è´¦æˆ·çŠ¶æ€ï¼Œå›æº¯ %s ç§’: account=%s", lookback_sec, account)
    # ä¸è¦ continueï¼Œç»§ç»­å¤„ç†äº¤æ˜“

# ä¿®æ”¹åï¼ˆæ–¹æ¡ˆ 2ï¼šæ›´æ¿€è¿›ï¼Œå›æº¯æ›´é•¿æ—¶é—´ï¼‰
if since_ms <= 0:
    since_ms = now_ms - int(24 * 3600 * 1000)  # å›æº¯ 24 å°æ—¶
    logger.info("åˆå§‹åŒ–ç›®æ ‡è´¦æˆ·çŠ¶æ€ï¼Œå›æº¯ 24 å°æ—¶: account=%s", account)
```

### 2. é‡ç½®çŠ¶æ€æ–‡ä»¶

åˆ é™¤æˆ–é‡ç½®çŠ¶æ€æ–‡ä»¶ï¼Œè®©ç¨‹åºé‡æ–°åˆå§‹åŒ–ï¼š
```bash
cd /home/user/POLYMARKET_MAKER_copytrade/POLYMARKET_MAKER_copytrade_v2/copytrade/
# å¤‡ä»½ç°æœ‰æ–‡ä»¶
mv copytrade_state.json copytrade_state.json.backup
mv tokens_from_copytrade.json tokens_from_copytrade.json.backup
```

### 3. éªŒè¯è´¦æˆ·å’Œ API

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯è´¦æˆ·æ˜¯å¦æœ‰æ•ˆï¼š
```python
# test_api.py
from smartmoney_query.api_client import DataApiClient
import datetime as dt

client = DataApiClient()
account = "0x96489abcb9f583d6835c8ef95ffc923d05a86825"
start_time = dt.datetime.now(dt.timezone.utc) - dt.timedelta(days=7)

trades = client.fetch_trades(account, start_time=start_time, page_size=100, max_pages=1)
print(f"è´¦æˆ·: {account}")
print(f"è·å–åˆ°äº¤æ˜“æ•°: {len(trades)}")
if trades:
    print(f"æœ€æ–°äº¤æ˜“: {trades[0]}")
```

### 4. æ·»åŠ è¯¦ç»†æ—¥å¿—

å¢å¼ºæ—¥å¿—è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•ï¼š
- API è¯·æ±‚æˆåŠŸ/å¤±è´¥
- è·å–åˆ°çš„äº¤æ˜“æ•°é‡
- è¢«è¿‡æ»¤æ‰çš„äº¤æ˜“åŠåŸå› 
- token_id æå–å¤±è´¥çš„è¯¦ç»†ä¿¡æ¯

### 5. æ£€æŸ¥è¿›ç¨‹è¿è¡ŒçŠ¶æ€

ç¡®ä¿ç¨‹åºå®é™…åœ¨è¿è¡Œï¼š
```bash
# æ£€æŸ¥è¿›ç¨‹
ps aux | grep copytrade

# æ£€æŸ¥æ—¥å¿—
tail -f /path/to/logs/copytrade_*.log

# å¦‚æœä½¿ç”¨ systemd
systemctl status copytrade
journalctl -u copytrade -f
```

---

## ğŸ¯ æ ¹æœ¬åŸå› 

**æ ¸å¿ƒé—®é¢˜æ˜¯é¦–æ¬¡è¿è¡Œæ—¶çš„é€»è¾‘é”™è¯¯**ï¼š
1. ç¨‹åºåˆå§‹åŒ–æ—¶å°† `last_timestamp_ms` è®¾ç½®ä¸ºå½“å‰æ—¶é—´
2. ç„¶åç«‹å³ `continue`ï¼Œä¸è·å–ä»»ä½•äº¤æ˜“
3. å¯¼è‡´ `tokens_from_copytrade.json` å§‹ç»ˆä¸ºç©º
4. ä¸‹æ¸¸çš„ `poly_maker_autorun.py` æ²¡æœ‰ä»»ä½• token å¯å¤„ç†
5. å› æ­¤æ°¸è¿œä¸ä¼šå¯åŠ¨ maker è¿›ç¨‹
6. **ç»“æœï¼šä¸€å¤©éƒ½ä¸ä¸‹å•**

ä¿®å¤è¿™ä¸ª `continue` è¯­å¥åï¼Œç³»ç»Ÿåº”è¯¥èƒ½å¤Ÿï¼š
1. æ­£å¸¸è·å–è·Ÿå•è´¦æˆ·çš„å†å²äº¤æ˜“
2. å†™å…¥ token åˆ° `tokens_from_copytrade.json`
3. `poly_maker_autorun.py` è¯»å– token å¹¶å¯åŠ¨ maker è¿›ç¨‹
4. å¼€å§‹æ­£å¸¸ä¸‹å•

---

## ğŸ“ é™„åŠ å»ºè®®

1. **æ·»åŠ å¥åº·æ£€æŸ¥**ï¼š
   - å®šæœŸæ£€æŸ¥ `tokens_from_copytrade.json` æ˜¯å¦æ›´æ–°
   - å¦‚æœé•¿æ—¶é—´æ²¡æœ‰æ›´æ–°ï¼Œå‘å‡ºå‘Šè­¦

2. **æ”¹è¿›é”™è¯¯å¤„ç†**ï¼š
   - API å¤±è´¥æ—¶åº”è¯¥é‡è¯•ï¼Œè€Œä¸æ˜¯ç›´æ¥è·³è¿‡
   - åŒºåˆ†"API å¤±è´¥"å’Œ"ç¡®å®æ²¡æœ‰äº¤æ˜“"

3. **æ·»åŠ æµ‹è¯•**ï¼š
   - å•å…ƒæµ‹è¯•éªŒè¯åˆå§‹åŒ–é€»è¾‘
   - é›†æˆæµ‹è¯•éªŒè¯æ•´ä¸ªæµç¨‹

4. **ç›‘æ§å’Œå‘Šè­¦**ï¼š
   - ç›‘æ§è¿›ç¨‹æ˜¯å¦è¿è¡Œ
   - ç›‘æ§ API è¯·æ±‚æˆåŠŸç‡
   - ç›‘æ§æ–‡ä»¶æ›´æ–°æ—¶é—´

5. **æ–‡æ¡£å®Œå–„**ï¼š
   - è¡¥å……éƒ¨ç½²æ–‡æ¡£
   - è¯´æ˜é¦–æ¬¡è¿è¡Œçš„æ³¨æ„äº‹é¡¹
   - æä¾›æ•…éšœæ’æŸ¥æŒ‡å—
