# POLYMARKET_MAKER_copytrade 总优化方案

> 目标：补齐从 POLYMARKET_MAKER_AUTO 与 copytrade_v3_muti 中移植的必要机制，形成可执行的改造清单与配置结构。此文件为设计方案，不含代码。

## 1. 总体目标与范围

- **目标**：在 `POLYMARKET_MAKER_copytrade` 中补齐“并发/线程限制、风险与黑名单、冷却/忽略机制、配置热更新、状态持久化”等缺失功能，并形成清晰的配置分区。
- **范围**：
  - 仅涉及 `POLYMARKET_MAKER_copytrade/` 目录新脚本与模块逻辑。
  - 复用 `POLYMARKET_MAKER_AUTO` 的 maker 交易逻辑，以及 `copytrade_v3_muti` 的信号/风控/状态等机制（以最小改动移植）。

---

## 2. 功能缺失清单 → 目标补齐

### 2.1 并发/线程限制（必需）

- **现状**：每个 token 直接启动线程，无上限；清仓线程也无限制。
- **目标**：支持以下能力：
  1. **最大并发 maker session**（类似 `scheduler.max_concurrent_jobs`）
  2. **最大清仓并发**（可单独配置）
  3. **全局任务调度节流**（避免瞬时大量线程启动）

**建议配置（新增）**：
```json
"scheduler": {
  "max_concurrent_jobs": 2,
  "max_concurrent_exit_jobs": 2,
  "topic_start_cooldown_sec": 3,
  "poll_interval_seconds": 5
}
```

**建议实现位置**：
- `modules/maker_engine.py`：加入并发信号量/线程池限制；启动前检查上限。
- `modules/position_manager.py`：清仓任务加入独立上限。
- `copytrade_maker.py`：主循环节流（沿用 `poll_interval_seconds`）。

---

### 2.2 黑名单机制（必需）

- **现状**：`POLYMARKET_MAKER_copytrade/config.json` 无 `blacklist_token_keys`；未做过滤。
- **目标**：复用 `copytrade_v3_muti/ct_risk.py` 的 blacklist 规则。

**建议配置（新增）**：
```json
"risk": {
  "blacklist_token_keys": []
}
```

**建议实现位置**：
- `modules/topic_selector.py`：过滤 `token_key` 或 `token_id` 命中黑名单。
- 或在 `modules/signal_tracker.py` 中过滤 signal → topic。

---

### 2.3 风险上限与是否允许做空（必需）

- **现状**：copytrade 侧没有 `max_notional_per_token`、`max_notional_total`、`allow_short` 等限制。
- **目标**：移植 `copytrade_v3_muti/ct_risk.py` 的限制逻辑。

**建议配置（新增）**：
```json
"risk": {
  "max_notional_per_token": 10,
  "max_notional_total": 100,
  "allow_short": false
}
```

**建议实现位置**：
- `modules/maker_engine.py`：下单前进行风险校验（可封装为 `risk_check`）。
- 与 maker 执行层配合，控制买入/卖出是否可执行。

---

### 2.4 冷却与 ignored token 机制（必需）

- **现状**：无冷却/忽略机制，可能反复触发同一 token。
- **目标**：引入 `ignored_tokens` 状态与冷却逻辑（参考 `copytrade_v3_muti/copytrade_run.py`）。

**建议配置（新增）**：
```json
"cooldown": {
  "cooldown_sec_per_token": 20,
  "orphan_ignore_sec": 120,
  "exit_ignore_cooldown": true
}
```

**建议实现位置**：
- `copytrade_maker.py`：维护 `ignored_tokens` 状态与过期清理。
- `modules/maker_engine.py`：启动 maker 前先判断是否在冷却中。

---

### 2.5 配置热更新（必需）

- **现状**：仅启动时读取一次配置。
- **目标**：支持 `config_reload_sec` 周期性重载。

**建议配置（新增）**：
```json
"config_reload_sec": 600
```

**建议实现位置**：
- `copytrade_maker.py`：参考 `copytrade_v3_muti/copytrade_run.py` 的 reload 逻辑。

---

### 2.6 状态持久化（推荐）

- **现状**：copytrade 侧不存储状态文件。
- **目标**：持久化保存 `ignored_tokens`、maker session 状态等（便于重启恢复）。

**建议配置（新增）**：
```json
"state": {
  "path": "state/copytrade_state.json"
}
```

**建议实现位置**：
- `copytrade_maker.py`：读写状态文件，定时保存。

---

### 2.7 订单簿请求节流与缓存（可选增强）

- **现状**：缺乏 `orderbook_refresh_sec`、`max_orderbook_fetch_per_loop` 等节流配置。
- **目标**：移植 copytrade_v3_muti 的节流能力，避免频繁请求。

**建议配置（新增）**：
```json
"orderbook": {
  "refresh_sec": 2,
  "max_fetch_per_loop": 30,
  "cache_max_items": 2000
}
```

**建议实现位置**：
- 若 maker 侧已有订单簿获取接口，则在 maker_engine 或 maker_execution 外围做节流。

---

### 2.8 maker 挂单策略关键参数补齐（必需）

- **现状**：`POLYMARKET_MAKER_copytrade` 仅保留了下单数量、价差、刷新间隔等基础字段，缺失了 **买入触发阈值、跌幅窗口、止盈比例、递增跌幅阈值** 等核心决策参数，导致挂单逻辑与 `POLYMARKET_MAKER_AUTO` 的实际策略不一致。
- **目标**：补齐 `POLYMARKET_MAKER_AUTO` 中 `Volatility_arbitrage_run.py` 与 `Volatility_arbitrage_strategy.py` 的核心策略参数，使 maker 侧买/卖触发条件与原策略一致。

**建议配置（新增）**：
```json
"maker_strategy": {
  "buy_price_threshold": null,
  "drop_window_minutes": 60,
  "drop_pct": 0.001,
  "profit_pct": 0.005,
  "enable_incremental_drop_pct": true,
  "incremental_drop_pct_step": 0.0002,
  "incremental_drop_pct_cap": 0.2,
  "disable_duplicate_signal": true,
  "disable_sell_signals": false,
  "min_price": 0.0,
  "max_price": 1.0,
  "min_market_order_size": null,
  "countdown": {
    "minutes_before_end": 300,
    "absolute_time": null,
    "timezone": null
  }
}
```

**参数说明（关键且必需）**：
- `buy_price_threshold`：绝对价格门槛（低于该价触发买入）。
- `drop_window_minutes` + `drop_pct`：窗口内高点回撤阈值，决定何时触发 BUY。
- `profit_pct`：止盈阈值（从成交价涨幅触发 SELL）。
- `enable_incremental_drop_pct` + `incremental_drop_pct_step`：卖出后抬高下一次买入阈值，避免频繁追单。
- `countdown`：接近市场截止时进入 sell-only，避免到期前买入。
- `min_price` / `max_price`：价格域守门，避免异常价触发信号。
- `min_market_order_size`：用以识别尘埃仓位/小额订单，保持与原策略一致。

**建议实现位置**：
- `modules/maker_engine.py`：接入 `Volatility_arbitrage_strategy` 触发逻辑或复刻关键判断分支。
- `copytrade_maker.py`：在启动/更新 maker 时注入策略参数与 countdown 控制。

---

### 2.9 maker 策略默认值与按话题覆盖（推荐）

- **现状**：copytrade 侧缺少对“默认策略 + topic 覆盖”的结构，无法精细化控制单个话题的挂单参数。
- **目标**：引入 `strategy_defaults.json` 类似的“默认 + 覆盖”机制。

**建议配置（新增）**：
```json
"maker_strategy_defaults": {
  "default": {
    "min_edge": 0.02,
    "max_position_per_market": 10.0,
    "order_size": 10.0,
    "spread_target": 0.01,
    "refresh_interval_seconds": 30,
    "max_open_orders": 20
  },
  "topics": {
    "election_2024": {
      "topic_name": "2024 Presidential Election",
      "max_position_per_market": 1000.0,
      "spread_target": 0.008,
      "order_size": 75.0
    }
  }
}
```

**建议实现位置**：
- `modules/maker_engine.py`：启动单 token 时先合并默认策略与 topic 覆盖配置。
- `copytrade_maker.py`：在 config reload 时同步刷新覆盖映射。

---

## 3. 配置结构草案（整合版）

```json
{
  "target_addresses": [],

  "signal_tracking": {
    "poll_interval_sec": 5
  },

  "maker_strategy": {
    "order_size": 10,
    "price_spread_bps": 50,
    "min_order_size": 5,
    "min_quote_amount": 1,
    "poll_interval_sec": 10,
    "refresh_interval_sec": 5,
    "sell_mode": "conservative",
    "aggressive_step": 0.01,
    "aggressive_timeout": 300,
    "exit_floor_price": 0,
    "exit_sell_mode": "aggressive",
    "buy_price_threshold": null,
    "drop_window_minutes": 60,
    "drop_pct": 0.001,
    "profit_pct": 0.005,
    "enable_incremental_drop_pct": true,
    "incremental_drop_pct_step": 0.0002,
    "incremental_drop_pct_cap": 0.2,
    "disable_duplicate_signal": true,
    "disable_sell_signals": false,
    "min_price": 0.0,
    "max_price": 1.0,
    "min_market_order_size": null,
    "countdown": {
      "minutes_before_end": 300,
      "absolute_time": null,
      "timezone": null
    }
  },

  "scheduler": {
    "max_concurrent_jobs": 2,
    "max_concurrent_exit_jobs": 2,
    "topic_start_cooldown_sec": 3,
    "poll_interval_seconds": 5
  },

  "risk": {
    "blacklist_token_keys": [],
    "max_notional_per_token": 10,
    "max_notional_total": 100,
    "allow_short": false
  },

  "cooldown": {
    "cooldown_sec_per_token": 20,
    "orphan_ignore_sec": 120,
    "exit_ignore_cooldown": true
  },

  "orderbook": {
    "refresh_sec": 2,
    "max_fetch_per_loop": 30,
    "cache_max_items": 2000
  },

  "config_reload_sec": 600,

  "state": {
    "path": "state/copytrade_state.json"
  },

  "maker_strategy_defaults": {
    "default": {
      "min_edge": 0.02,
      "max_position_per_market": 10.0,
      "order_size": 10.0,
      "spread_target": 0.01,
      "refresh_interval_seconds": 30,
      "max_open_orders": 20
    },
    "topics": {}
  },

  "logging": {
    "level": "INFO",
    "path": "logs/app.log"
  }
}
```

---

## 4. 改造步骤（执行顺序建议）

1. **配置结构升级**：新增 `scheduler`、`risk`、`cooldown`、`state` 分区。
2. **并发限制实现**：在 `maker_engine` / `position_manager` 添加并发控制。
3. **黑名单 + 风控接入**：整合 `ct_risk.py` 逻辑，统一风险入口。
4. **冷却与 ignored 机制**：加入状态维护与过期清理。
5. **maker 触发策略补齐**：增加 drop/buy/profit/countdown 等核心字段与策略接入。
6. **默认策略 + topic 覆盖**：支持话题级别的差异化配置。
7. **配置热更新**：对 config.json 实现定时 reload。
8. **状态持久化**：存储 ignored 与 session 状态。
9. **可选增强**：订单簿节流与缓存策略。

---

## 5. 预期效果

- 避免大量 token 触发后线程爆炸。
- 具备 blacklist 与风险上限控制。
- 降低重复信号导致的频繁启动/停止。
- 支持配置热更新与重启恢复。

---

如需我继续输出 **“分模块字段映射表 / 风控逻辑细化 / 并发调度实现细节”**，可以直接说明格式要求。
