# POLYMARKET_MAKER_copytrade 设计方案

> 目标：设计一个新脚本，整合「追踪目标账户买卖信号」与「maker 波段交易」两套逻辑，实现以目标账户信号驱动的 maker 波段自动交易；输出仅为方案，不含代码。

## 1. 需求概述

- **新脚本位置**：放在 `POLYMARKET_MAKER_copytrade/` 目录下。
- **信号来源（思路 1）**：从 `copytrade_v3_muti` 中移植追踪目标账户、获取仓位信息与买卖信号的完整逻辑，仅保留用于提取目标账户买卖 **topics** 的部分，丢弃跟单下单执行。
- **交易引擎（思路 2）**：从 `POLYMARKET_MAKER_AUTO` 中移植 maker 自动买卖（波段）的完整逻辑，仅保留 maker 波段交易功能，丢弃全市场筛选项目功能。
- **组合逻辑（思路 3）**：将（思路 1）筛选出的 topics 作为买入目标话题，使用（思路 2）的 maker 波段交易执行持续买卖。
- **启动/停止条件**：
  - 使用（思路 1）中的**买入信号**作为启动 maker 波段的开始信号。
  - 使用（思路 1）中的**SELL 信号**作为停止 maker 波段并清仓的信号。
- **配置文件整合**：融合两套 JSON 配置，保留必要参数，删除不需要参数。

## 2. 新脚本职责与结构

### 2.1 脚本职责

1. **目标账户追踪模块**：订阅/轮询目标账户仓位与交易事件，提取买入/卖出信号与对应 topics。
2. **信号状态机**：根据 BUY/SELL 信号驱动 maker 波段交易引擎启停。
3. **maker 波段交易引擎**：在给定 topics 及市场条件下循环挂单/撤单/成交管理。
4. **风险与清仓逻辑**：收到 SELL 信号时，终止 maker 循环并清仓。

### 2.2 拟定文件结构

```
POLYMARKET_MAKER_copytrade/
  ├─ 设计方案.md
  ├─ copytrade_maker.py            # 新脚本：主入口
  ├─ config.json                   # 合并后的配置
  ├─ modules/
  │   ├─ signal_tracker.py         # 目标账户信号追踪
  │   ├─ maker_engine.py           # maker 波段交易引擎
  │   ├─ topic_selector.py         # 根据信号筛选 topics
  │   └─ position_manager.py       # 清仓/风控/订单管理
  └─ logs/
```

> 文件名仅为建议，最终可按现有项目风格调整。

## 3. 功能拆解与移植策略

### 3.1 目标账户信号追踪（来自 copytrade_v3_muti）

**目标**：移植“追目标账户仓位与买卖信号”的逻辑，输出 topics + BUY/SELL 信号。

**保留模块**：
- 目标账户列表与订阅逻辑
- 获取目标账户仓位/交易事件
- 买卖信号判定逻辑（BUY/SELL）
- 解析/映射为 **topic** 的逻辑

**舍弃模块**：
- 跟单下单执行（所有真实买卖执行）
- 跟单风控或执行相关的业务逻辑

**输出定义**：
```json
{
  "signal_type": "BUY" | "SELL",
  "topics": ["topic_1", "topic_2"],
  "timestamp": 1700000000,
  "source_account": "0x..."
}
```

### 3.2 maker 波段交易引擎（来自 POLYMARKET_MAKER_AUTO）

**目标**：移植 maker 自动买卖与挂单策略逻辑，不负责全市场筛选。

**保留模块**：
- maker 挂单策略（价格区间、挂单数量、订单管理）
- 撤单/补单/成交跟踪
- 仓位管理与风险参数

**舍弃模块**：
- 全市场筛选/热门话题探测
- 任何与“市场筛选”相关的数据抓取

**输入定义**：
- topics 列表（来自目标账户信号）
- 启动/停止指令

### 3.3 信号状态机与执行流程

**核心逻辑**：
- 收到 BUY 信号 → 将 topics 写入“激活话题列表” → 启动 maker 波段交易。
- 收到 SELL 信号 → 触发停止 → 对该 topics 或对应仓位进行清仓。

**状态机示意**：

```
IDLE
  └─(BUY Signal)→ RUNNING
RUNNING
  └─(SELL Signal)→ EXITING → IDLE
```

**策略细节**：
- RUNNING 阶段持续循环 maker 策略。
- EXITING 阶段执行：撤销未成交订单 → 市价/限价清仓 → 归档结果。
- 每个 topic 独立管理状态（可并发）。

## 4. 配置文件整合（config.json）

### 4.1 配置整合原则

- 仅保留新脚本实际使用的参数。
- **信号追踪**与 **maker 策略**分区配置。
- 删除跟单执行相关字段、市场筛选字段。

### 4.2 拟定配置结构

```json
{
  "network": {
    "rpc_url": "",
    "chain_id": 137
  },
  "accounts": {
    "maker_private_key": "",
    "target_accounts": ["0x..."]
  },
  "signal_tracking": {
    "poll_interval_sec": 5,
    "min_position_change": 0.0,
    "topic_mapping": "auto"
  },
  "maker_strategy": {
    "order_size": 10,
    "price_spread_bps": 50,
    "max_orders": 5,
    "refresh_interval_sec": 10
  },
  "risk": {
    "max_position_per_topic": 100,
    "stop_loss_bps": 200
  },
  "logging": {
    "level": "INFO",
    "path": "logs/app.log"
  }
}
```

> 实际字段名称以原仓库配置为准，最终移植时精简。

## 5. 关键流程（伪代码）

```python
while True:
    signal = signal_tracker.fetch_signal()

    if signal.type == "BUY":
        active_topics.add(signal.topics)
        maker_engine.start(topics=signal.topics)

    if signal.type == "SELL":
        maker_engine.stop(topics=signal.topics)
        position_manager.close_positions(topics=signal.topics)

    maker_engine.tick()
    sleep(loop_interval)
```

## 6. 风险控制与异常处理

- **信号重复**：若收到重复 BUY 信号，需去重或更新活跃话题列表。
- **信号丢失**：长期未收到信号时，维持原状态；可设置超时规则。
- **订单异常**：撤单失败、成交查询失败时重试；必要时暂停交易。
- **账户权限**：只使用 maker 账户私钥；目标账户只读。

## 7. 交付物清单

1. `POLYMARKET_MAKER_copytrade/设计方案.md`（本文件）
2. 新脚本与模块文件结构（后续实现）
3. 合并后的 `config.json` 模板（后续实现）

## 8. 下一步实现建议（非代码）

1. 确认 `copytrade_v3_muti` 中追踪目标账户的核心入口与信号输出格式。
2. 确认 `POLYMARKET_MAKER_AUTO` 中 maker 策略的核心入口与配置字段。
3. 定义新脚本的主运行流程与模块边界。
4. 完成配置文件合并与默认值制定。

---

如需进一步细化，我可以在不写代码的前提下，继续补充模块接口定义与字段映射表。
